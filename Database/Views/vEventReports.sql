/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:21:39 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: VIEW
*/
CREATE VIEW [dbo].[vEventReports] (DeviceID, TrackerNumber, EventTime, EventID,
	AlarmType, AlarmAssignmentStatusID, AlarmAssignmentStatusName, EventName,
	Longitude,Latitude,Address,
--Speed,Heading,LastLongitude, LastLatitude, 
	OffenderName, OffenderID,NoteCount,AlarmID,
	GpsValid,GpsValidSatellites,
--InternalBatteryVoltage,ExternalBatteryVoltage,
	GeoRule,
--GeoRuleName,
	SO,OPR,EventTypeGroupID,
	OfficerID, OfficerName, AgencyID,Agency, AcceptedDate, AcceptedBy)AS
SELECT DISTINCT	
	e.DeviceID, 
	t.TrackerNumber,
	e.EventTime, 
	e.EventID,
	ISNULL(e.AlarmType, 1) AS 'AlarmType', -- 1: notification
	ISNULL(aa.AlarmAssignmentStatusID,0) as 'AlarmAssignmentStatusID',
	ISNULL(aas.AlarmAssignmentStatusName,'Unassigned') as 'AlarmAssignmentStatusName',
	(
		CASE
			WHEN a.EventTypeID = 256 AND a.EventParameter > 0
			THEN et.AbbrevEventType + ' ' + CONVERT(nvarchar(4),a.EventParameter)
			ELSE et.AbbrevEventType
		END
	) AS 'EventName',
	ISNULL(ROUND(e.Longitude,5), 0) AS 'Longitude',
	ISNULL(ROUND(e.Latitude,5), 0) AS 'Latitude',
	e.Address AS 'Address',
--	e.Speed,
--	e.Heading,
--	ISNULL(ROUND(e2.Longitude,5), 0) AS 'LastLongitude',
--	ISNULL(ROUND(e2.Latitude,5), 0) AS 'LastLatitude',
	ISNULL(o.FirstName + ' ', '') + 
	ISNULL(o.MiddleName + ' ', '') + 
	ISNULL(o.LastName, '') AS 'OffenderName',
	o.OffenderID,
	(SELECT COUNT (*) FROM EventNote en WHERE en.DeviceID = e.DeviceID AND en.EventTime = e.EventTime AND en.EventID = e.EventID) + (SELECT COUNT (*) FROM AlarmNote an WHERE an.AlarmID = a.AlarmID) AS 'NoteCount',
	a.AlarmID,
	isnull(e.GpsValid,0) as 'GpsValid',
	isnull(e.GpsValidSatellites,0) as 'GpsValidSatellites',
	(
		CASE
			WHEN et.EventTypeGroupID =5
			THEN gr.GeoRuleName 
			ELSE 'N/A'
		END
	) AS 'GeoRule',
--	(
--		CASE
--			WHEN et.EventTypeGroupID =5
--			THEN gr.GeoRuleName 
--			ELSE 'N/A'
--		END
--	) AS 'GeoRuleName',
	et.SO,
	et.OPR,
	et.EventTypeGroupID,
	oo.OfficerID as OfficerID,
	ISNULL(ofcr.FirstName + ' ', '' ) +
	ISNULL(ofcr.MiddleName + ' ', '' ) +
	ISNULL(ofcr.LastName, '') AS 'OfficerName',
	o.AgencyID,
	ag.Agency,
	aa.AssignedDate AS 'AcceptedDate',
	ISNULL(u.UserName,'') AS 'AcceptedBy'
--	e.InternalBatteryVoltage,
--    e.ExternalBatteryVoltage
FROM
	[dbo].[fnAllEvents] () e
--	Gateway.dbo.Events e
	LEFT JOIN EventType et ON e.EventID = et.EventTypeID
--	LEFT JOIN Gateway.dbo.EventTypes ge ON ge.Eventid = et.EventTypeID
	LEFT JOIN Alarm a ON 
		e.DeviceID = a.TrackerID 
		AND e.EventTime = a.EventTime 
		AND e.EventID = a.EventTypeID
	LEFT JOIN Tracker t ON t.TrackerID = e.DeviceID		
	INNER JOIN OffenderTrackerActivation ota on ota.trackerid = e.DeviceID AND (
		 (ota.activateDate< Convert(DateTime,
				(DATEADD(ms, (e.EventTime / CAST(10000 AS bigint)) % 86400000,
				DATEADD(day, e.EventTime / CAST(864000000000 AS bigint) - 109207, 0))))
		 and ota.DeActivateDate> Convert(DateTime,
				(DATEADD(ms, (e.EventTime / CAST(10000 AS bigint)) % 86400000,
				DATEADD(day, e.EventTime / CAST(864000000000 AS bigint) - 109207, 0)))))
		or
		(ota.activateDate<Convert(DateTime,
				(DATEADD(ms, (e.EventTime / CAST(10000 AS bigint)) % 86400000,
				DATEADD(day, e.EventTime / CAST(864000000000 AS bigint) - 109207, 0))))
		and ota.DeActivateDate is null))
	LEFT JOIN Offender o ON o.offenderID = ota.OffenderID AND o.Deleted = 0
	LEFT JOIN Agency ag ON o.AgencyID = ag.AgencyID
	LEFT JOIN Offender_Officer oo ON o.OffenderID = oo.OffenderID
	LEFT JOIN Officer ofcr ON ofcr.OfficerID = oo.OfficerID
	LEFT JOIN AlarmAssignment aa on a.alarmId = aa.alarmid AND aa.AssignedDate = (
		SELECT MAX(AssignedDate) FROM AlarmAssignment AAD WHERE aad.AlarmID = a.AlarmID
	)
	LEFT JOIN AlarmAssignmentStatus aas on aas.AlarmAssignmentStatusID = aa.AlarmAssignmentStatusID 
	LEFT JOIN [User] u ON u.UserID = aa.AssignedByID
	LEFT JOIN GeoRule gr ON gr.GeoRuleID = a.EventParameter
--    LEFT JOIN Gateway.dbo.Events e2 on e2.deviceid= e.deviceid and e2.eventtime = (select max(e3.eventtime) from Gateway.dbo.Events e3 where e3.deviceid= e2.deviceid and e3.eventtime<e.eventtime )
WHERE
	( 
		(e.EventTime >= 127961856000000000) AND (e.EventID <> 160)
	)
GO
