/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:27 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [OffenderGetBeforeNoEventTimeAlarm]
	@OffenderID	INT,
	@SO			INT,
	@OPR		INT
AS
BEGIN
	SET NOCOUNT ON;


SELECT top 1 a.EventDisplayTime AS 'LastEventDisplayTime'		
		FROM  Alarm a 
 		JOIN EventType et ON a.EventTypeID = et.EventTypeID 
		join OffenderTrackerActivation ota on ota.OffenderID = a.OffenderID and ota.TrackerID =a.TrackerID AND(
			 (ota.activateDate< a.EventDisplayTime
			 and ota.DeActivateDate> a.EventDisplayTime)
			or
			(ota.activateDate<a.EventDisplayTime
			 and ota.DeActivateDate is null))
	WHERE	a.OffenderID = @OffenderID 	
				and (
					(@SO<0)
					or
					 (et.SO=@SO)
				)
				and (
					(@OPR<0)
					or
					(et.OPR=@OPR)
				) and a.EventTypeID <> 256
				
	ORDER BY a.eventtime desc, a.AlarmID desc
END

GO
GRANT EXECUTE ON [OffenderGetBeforeNoEventTimeAlarm] TO [db_dml]
GO
GRANT VIEW DEFINITION ON [OffenderGetBeforeNoEventTimeAlarm] TO [db_object_def_viewers]
GO
