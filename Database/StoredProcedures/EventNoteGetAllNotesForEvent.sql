/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:27 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [EventNoteGetAllNotesForEvent]
	@DeviceID int, 
	@EventTime bigint,
	@EventID int
	
AS
BEGIN
	SET NOCOUNT ON;

	--Union both Event Notes and Alarm Notes
	SELECT 
		en.Note, 
		u.UserName, 
		en.CreatedDate
	FROM 
		EventNote en
		LEFT JOIN [User] u ON en.CreatedByID = u.UserID
	WHERE 
		DeviceID = @DeviceID 
		AND EventTime = @EventTime 
		AND EventID = @EventID

UNION

	SELECT 
		an.Note, 
		u.UserName, 
		an.CreatedDate
	FROM 
		AlarmNote an
		LEFT JOIN Alarm a ON a.AlarmID = an.AlarmID
		LEFT JOIN [User] u ON an.CreatedByID = u.UserID
--		LEFT JOIN Gateway.dbo.Events e ON e.DeviceID = a.TrackerID 
--			AND e.EventTime = a.EventTime 
--			AND e.EventID = a.EventTypeID
	WHERE 
		a.Trackerid = @DeviceID AND
		a.EventTime = @EventTime AND
		a.EventtypeID = @EventID

END

GO
GRANT VIEW DEFINITION ON [EventNoteGetAllNotesForEvent] TO [db_object_def_viewers]
GO
GRANT EXECUTE ON [EventNoteGetAllNotesForEvent] TO [db_dml]
GO
