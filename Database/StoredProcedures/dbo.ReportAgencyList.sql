/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:27 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [ReportAgencyList]
	@GatewayPort varchar(10),
	@GatewayIp varchar(20)
AS
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
SELECT TOP 5000	
		a.AgencyID,
		a.Agency,
		a.phone,
		(
			select  count( DISTINCT T.TrackerID)  
				from Tracker t
				LEFT join Gateway.dbo.Devices d on d.deviceId = t.TrackerID
				LEFT JOIN OffenderTrackerActivation ota ON ota.TrackerID = t.TrackerID
				AND ota.ActivateDate = (SELECT MAX(ActivateDate) FROM OffenderTrackerActivation OTA WHERE OTA.TrackerID = t.TrackerID)
				LEFT JOIN Offender o ON (t.TrackerID = o.TrackerID AND o.Deleted = 0)
				left join Gateway.dbo.DeviceProperties dp1 on dp1.DeviceID = d.DeviceID and  dp1.propertyID='8410'
				left join Gateway.dbo.DeviceProperties dp2 on dp2.DeviceID = d.DeviceID and dp2.propertyID='8411'
	
				where t.agencyid= a.AgencyID
				and ((deactivateDate is null and activateDate is not null)or(activatedate> deactivateDate))
				and
				(
					(o.OffenderID is not null)
					or
					(
						(
							(dp1.PropertyValue= @GatewayIp)
							and 	 
							(dp2.PropertyValue= @GatewayPort)
						)
					)
				)
				and t.deleted!=1
				
		) as 'ActiveDevices',
		(
			select  count(DISTINCT T.TrackerID)  
				from Tracker t
				LEFT join Gateway.dbo.Devices d on d.deviceId = t.TrackerID
				LEFT JOIN OffenderTrackerActivation ota ON ota.TrackerID = t.TrackerID
				AND ota.ActivateDate = (SELECT MAX(ActivateDate) FROM OffenderTrackerActivation OTA WHERE OTA.TrackerID = t.TrackerID)
				LEFT JOIN Offender o ON (t.TrackerID = o.TrackerID AND o.Deleted = 0)
				left join Gateway.dbo.DeviceProperties dp1 on dp1.DeviceID = d.DeviceID and  dp1.propertyID='8410'
				left join Gateway.dbo.DeviceProperties dp2 on dp2.DeviceID = d.DeviceID and dp2.propertyID='8411'
	
				where t.agencyid= a.AgencyID
				and ((activateDate is null)or(deactivateDate>activatedate))
				and
				(
					(o.OffenderID is not null)
					or
					(
						(
							(dp1.PropertyValue= @GatewayIp)
							and 	 
							(dp2.PropertyValue= @GatewayPort)
						)
					)
				)
				and t.deleted!=1
			
		)  as 'InactiveDevices',
		
		(select top 1  
			ISNULL(o.FirstName + ' ', '') + 
			ISNULL(o.MiddleName + ' ', '') + 
			ISNULL(o.LastName, '')
				from officer o
				join User_role ur on ur.UserID =o.UserID and ur.RoleID=2
				where a.AgencyID = o.AgencyID order By o.CreatedDate asc
		 ) as 'AgencyContact'
		FROM	Agency a
		WHERE	a.Deleted = 0 
		ORDER BY a.Agency
GO
GRANT EXECUTE ON [ReportAgencyList] TO [db_dml]
GO
GRANT VIEW DEFINITION ON [ReportAgencyList] TO [db_object_def_viewers]
GO
