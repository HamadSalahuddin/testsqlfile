/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:27 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [ReportAlarmNotesDetail]

        @StartDate              BIGINT,
        @EndDate                BIGINT,
        @AgencyID               INT,
        @OfficerID              INT,
        @TimeZoneOffset INT

AS
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
Select a.* INTO #Alarmtmp
from Alarm a WITH (NOLOCK)                     
JOIN Offender o ON o.Offenderid = a.Offenderid
JOIN Offender_Officer oo ON oo.Offenderid = o.Offenderid
JOIN officer ofi ON ofi.officerid = oo.Officerid
Where EventTime >=@StartDate AND EventTime <= @EndDate
AND ofi.Officerid = @Officerid

SELECT  TOP 5000
                                                (DATEADD ( mi, @TimeZoneOffset, (Convert(DateTime,a.EventDisplayTime)))) as EventTime,
                                                (
                                                        CASE
                                                        WHEN a.EventTypeID = 256 AND a.EventParameter > 0
                                                        THEN et.AbbrevEventType + ' ' + CONVERT(nvarchar(4),a.EventParameter)
                                                        ELSE et.AbbrevEventType
                                                        END
                                                ) AS EventName,
                                                ISNULL(o.FirstName + ' ', '') +
                                                ISNULL(o.MiddleName + ' ', '') +
                                                ISNULL(o.LastName, '') AS 'OffenderName',
                                                CASE 
												WHEN a.Longitude <> 0 AND  a.Longitude <> 0 THEN 
												CONVERT(VARCHAR,a.Longitude) + ', ' + CONVERT(VARCHAR,a.Latitude)

												WHEN e.Address is null AND a.Longitude = 0 AND  a.Longitude = 0 THEN 
												'unavailable'

												WHEN e.Address is not null AND a.Longitude = 0 AND  a.Longitude = 0 THEN 
												e.Address
												WHEN e.Address is not null AND a.Longitude <> 0 AND  a.Longitude <> 0 THEN 
												e.Address

												END AS Address,

                                                DATEDIFF(ss,a.EventDisplayTime,a.CreatedDate) AS 'Latency',
                                                CASE WHEN
                                                u.username is null
                                                then ''
                                                else
                                                Convert(varchar(20),isnull(DATEADD(mi,@TimeZoneOffset,an.CreatedDate),''))  + ' - ' + isnull(u.username,'') + ' - ' + isnull(an.note,'')
                                                END
                                                as 'AlarmNote',
                                                --a.AlarmID, --a.AlarmTypeID,
                                                o.OffenderID,
                                               ISNULL(officer.FirstName + ' ', '') +
                                              ISNULL(officer.MiddleName + ' ', '') +
                                              ISNULL(officer.LastName, '') AS 'OfficerName',
                                             ag.Agency--,
                  			     --case when dbo.fnIsAlarmAutoCompleted(e.AlarmID) > 0 then 'Autocompleted Alarms' 
  					     --else 'Regular Alarms' end as 'IsAlarmsAutoCompleted' 
                                FROM    #Alarmtmp a
								        INNER JOIN [dbo].[EventBuckets] e ON a.AlarmID = e.AlarmID
                                LEFT JOIN EventType et ON a.EventTypeID = et.EventTypeID
                                LEFT JOIN Offender o ON a.OffenderID = o.OffenderID
                                left JOIN Offender_Officer oo ON o.OffenderID = oo.OffenderID
                                inner join AlarmNote an on an.AlarmID = a.AlarmID
                                left join officer  on officer.OfficerID = oo.OfficerID
                                Left join Agency ag on ag.AgencyID = officer.AgencyID
                                left Join [user] u on u.Userid = an.createdbyID
                                WHERE   --a.AlarmID NOT IN (SELECT AlarmID FROM AlarmAcknowledgement)and
                                                 (
                                                        ( @StartDate = 0 AND @EndDate = 0)
                                                        or
                                                        (a.EventTime >= @StartDate AND
                                                        a.EventTime <= @EndDate
                                                        )
                                                 )
                                        and     (
                                                        (@AgencyID= 0)
                                                        or
                                                        (o.AgencyID = @AgencyID)
                                                )
                                        and     (
                                                        (@OfficerID= 0)
                                                        or
                                                        (oo.OfficerID = @OfficerID)
                                                )

                        --IsAlarmsAutoCompleted, 
ORDER BY  'OffenderName' ASC ,EventTime ASC

Drop Table #Alarmtmp








-- select * from alarmnote where note like '&Auto Generated note&'


GO
GRANT EXECUTE ON [ReportAlarmNotesDetail] TO [db_dml]
GO
GRANT VIEW DEFINITION ON [ReportAlarmNotesDetail] TO [db_object_def_viewers]
GO
