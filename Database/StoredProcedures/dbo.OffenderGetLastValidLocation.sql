/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:27 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [OffenderGetLastValidLocation]

	@OffenderID	INT,
	@SO			INT,
	@OPR		INT

AS


		SELECT	top 1 
				ISNULL(ROUND(e.Longitude,5), 0) AS 'LastLongitude',	
				ISNULL(ROUND(e.Latitude,5), 0) AS 'LastLatitude' ,	
				e.Address AS 'address',						
				e.EventTime  AS 'LastValidTime',				
				e.EventID	
		
		FROM  [fnAllEvents] () e 
 		LEFT JOIN EventType et ON e.EventID = et.EventTypeID 
		join OffenderTrackerActivation ota on ota.OffenderID = @OffenderID and ota.TrackerID =e.deviceID AND(
			 (ota.activateDate< Convert(DateTime,
			(DATEADD(ms, (e.EventTime / CAST(10000 AS bigint)) % 86400000,
			DATEADD(day, e.EventTime / CAST(864000000000 AS bigint) - 109207, 0))))
	and ota.DeActivateDate> Convert(DateTime,
			(DATEADD(ms, (e.EventTime / CAST(10000 AS bigint)) % 86400000,
			DATEADD(day, e.EventTime / CAST(864000000000 AS bigint) - 109207, 0)))))
	or
	(ota.activateDate<Convert(DateTime,
			(DATEADD(ms, (e.EventTime / CAST(10000 AS bigint)) % 86400000,
			DATEADD(day, e.EventTime / CAST(864000000000 AS bigint) - 109207, 0))))
	 and ota.DeActivateDate is null))
	WHERE  e.Eventid=0  and e.GpsValid=1 and e.GpsValidSatellites=1 and e.Longitude <>0 and e.Latitude <>0
				and (
					(@SO<0)
					or
					 (et.SO=@SO)
				)
				and (
					(@OPR<0)
					or
					(et.OPR=@OPR)
				)
				
	ORDER BY e.eventtime desc







/*
(select MAX(EventTime) from Gateway.dbo.Events e1 where e1.DeviceID = o.TrackerID and e1.Eventid=0  and e1.GpsValid=1 and e1.GpsValidSatellites=1 and e1.Longitude <>0 and e1.Latitude <>0)		
*/
GO
GRANT EXECUTE ON [OffenderGetLastValidLocation] TO [db_dml]
GO
GRANT VIEW DEFINITION ON [OffenderGetLastValidLocation] TO [db_object_def_viewers]
GO
