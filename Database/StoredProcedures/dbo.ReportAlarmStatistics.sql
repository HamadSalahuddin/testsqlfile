/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:27 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
--DROP PROCEDURE ReportAlarmStatistics
CREATE PROCEDURE [ReportAlarmStatistics]

	@StartDate		BIGINT,
	@EndDate		BIGINT,
	@AgencyID		INT,
	@OfficerID		INT
	
AS
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
SELECT	TOP 5000
	COUNT(a.AlarmID) AS 'AlarmCount',
	COUNT(DISTINCT a.AlarmGroupID) AS 'AlarmGroupCount',
	case when dbo.fnIsAlarmAutoCompleted(a.AlarmID) > 0 then et.longname + '(AutoCompleted-Alarms)' 
	else et.longname + ' (Regular-Alarms)' end AS 'EventName',
	ISNULL(o.FirstName+' ','')+ISNULL(o.MiddleName+' ','')+ISNULL(o.LastName,'') AS 'OffenderName',
	o.OffenderID,
	ISNULL(officer.FirstName+' ','')+ISNULL(officer.MiddleName+' ','')+ISNULL(officer.LastName,'') AS 'OfficerName',
	ag.Agency
FROM	
	Alarm a
--	LEFT JOIN Gateway.dbo.EventTypes et ON a.EventTypeID = et.EventID
	LEFT JOIN EventType et ON a.EventTypeID = et.EventtypeID
	LEFT JOIN Offender o ON a.OffenderID = o.OffenderID
	LEFT JOIN Offender_Officer oo ON o.OffenderID = oo.OffenderID
	LEFT JOIN Officer ON officer.OfficerID = oo.OfficerID 
	LEFT JOIN Agency ag ON ag.AgencyID = officer.AgencyID
WHERE	
	(
		(@StartDate = 0 AND @EndDate = 0) 
		OR
		(a.EventTime >= @StartDate AND a.EventTime <= @EndDate)
	)
	AND	
	(
		(@AgencyID = 0)
		OR
		(o.AgencyID = @AgencyID)
	)
	AND	
	(
		(@OfficerID = 0)
		OR
		(oo.OfficerID = @OfficerID)
	)
GROUP BY  
	o.OffenderId, et.LongName, o.FirstName, o.MiddleName, o.LastName, 
	officer.FirstName, officer.MiddleName, officer.LastName, ag.Agency , dbo.fnIsAlarmAutoCompleted(a.alarmID)



GO
GRANT EXECUTE ON [ReportAlarmStatistics] TO [db_dml]
GO
GRANT VIEW DEFINITION ON [ReportAlarmStatistics] TO [db_object_def_viewers]
GO
