/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:26 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [AgencyGetTimezoneUtcOffset] 
	@TimezoneUtcOffset int OUTPUT,
	@AgencyID	int,
	@Year		int = 0
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE @TodaysDate DateTime
	SET @TodaysDate = GETUTCDATE()

	SET @TimezoneUtcOffset = 
	(SELECT TOP 1
		CASE
			WHEN 
				ag.DaylightSavings IS NOT NULL 
				AND ag.DaylightSavings > 0 
				AND DateAdd(mi,tz.UtcOffset,@TodaysDate) >= (SELECT Start FROM DaylightSaving WHERE [Year] = YEAR( @TodaysDate )) 
				AND DateAdd(mi,tz.UtcOffset,@TodaysDate) <= (SELECT [End] FROM DaylightSaving WHERE [Year] = YEAR( @TodaysDate )) 
			THEN
				tz.DaylightUtcOffset
			ELSE
				tz.UtcOffset
		END --AS 'TimezoneUtcOffset'
	FROM
		[TimeZone] tz
		LEFT JOIN Agency ag ON ag.TimeZoneID = tz.TimeZoneID AND ag.AgencyID = @AgencyID
	WHERE
		AgencyID = @AgencyID
	)

	RETURN @TimezoneUtcOffset

END
GO
GRANT VIEW DEFINITION ON [AgencyGetTimezoneUtcOffset] TO [db_object_def_viewers]
GO
GRANT EXECUTE ON [AgencyGetTimezoneUtcOffset] TO [db_dml]
GO
