/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:27 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [ReportEarrestBillingNew]

@StartDate Datetime, 
@EndDate DateTime

--Set @Agencyid = 515
--SET @StartDate = '2009-04-01'
--SET @EndDate = '2009-05-01'
AS
Select
ag.AgencyID
,ag.Agency
,ofi.FirstName+' '+ofi.LastName As Officer
,o.FirstName+' '+o.LastName AS 'Offender'
,DATEADD(mi,-360,ebs.StartDate) As EarrestStartDate
,DATEADD(mi,-360,ebs.EndDate) As EarrestEndDate
,(Case When DATEADD(mi,-360,ebs.StartDate) < @StartDate AND ebs.EndDate Is NOT NULL THEN 
		DateDiff(dd,@StartDate,DATEADD(mi,-360,ebs.EndDate)+1)
 When DATEADD(mi,-360,ebs.StartDate) < @StartDate AND ebs.EndDate Is NULL THEN
		DateDiff(dd,@StartDate,@EndDate)+1
 When DATEADD(mi,-360,ebs.StartDate) > @StartDate AND ebs.EndDate Is NOT NULL THEN 
		DateDiff(dd,DATEADD(mi,-360,ebs.StartDate),DATEADD(mi,-360,ebs.EndDate)+1)
 When DATEADD(mi,-360,ebs.StartDate) > @StartDate AND ebs.EndDate Is NULL THEN
		DateDiff(dd,DATEADD(mi,-360,ebs.StartDate),@EndDate)+1 END)AS 'Total Days'

 

From dbo.EArrestBillingStatus ebs
JOIN Offender o ON o.Offenderid = ebs.Offenderid
JOIN Offender_Officer oo ON oo.Offenderid = ebs.Offenderid
JOIN Officer ofi ON ofi.Officerid = oo.Officerid
JOIN Agency ag ON ag.Agencyid = o.Agencyid
Where 
DATEADD(mi,-360,ebs.StartDate)<@EndDate AND (DATEADD(mi,-360,ebs.EndDate)>@StartDate OR ebs.EndDate IS NULL)
Order BY ag.Agency,Officer,'Offender'

GO
GRANT EXECUTE ON [ReportEarrestBillingNew] TO [db_dml]
GO
