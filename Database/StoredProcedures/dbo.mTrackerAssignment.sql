/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:27 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [mTrackerAssignment]
	@TrackerAssignmentID INT OUTPUT,
	@TrackerID INT,
	@OffenderID INT,
	@OfficerID INT,
	@AssignmentDate DATETIME OUTPUT,
	@CreatedByID INT

AS

SET @AssignmentDate = GETDATE()
   
 IF ((SELECT COUNT(t.TrackerID) FROM Tracker t WHERE Deleted = 0 AND @AssignmentDate < t.CreatedDate AND t.TrackerID = @TrackerID) > 0)
	BEGIN
		RAISERROR( 'Tracker mustn´t be assigned to Offender before Agency', 16, 20 )
	END
 ELSE
	BEGIN

		INSERT INTO TrackerAssignment(
			TrackerID,
			OffenderID,
			SupervisionOfficerID,
			AssignmentDate,
			TrackerAssignmentTypeID,
			CreatedBy,
			CreatedDate
			)
		VALUES(
			@TrackerID,
			@OffenderID,
			@OfficerID,
			@AssignmentDate,
			1,
			@CreatedByID,
			@AssignmentDate
			)

		SET @TrackerAssignmentID = SCOPE_IDENTITY()

    END

GO
GRANT EXECUTE ON [mTrackerAssignment] TO [db_dml]
GO
