/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:27 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [mTrackerActivate]

	@TrackerActivationID INT OUTPUT,
	@TrackerID INT,
	@OffenderID INT,
	@OfficerID INT,
	@ModifiedByID INT,
	@ActivateDate DATETIME OUTPUT,
	@IsDemo BIT OUTPUT,
	@BillableID INT OUTPUT

AS

SET @ActivateDate = GETDATE()

SELECT TOP 1
	@IsDemo = IsDemo,
	@BillableID = BillableID
FROM
	Tracker
WHERE
	TrackerID = @TrackerID AND Deleted = 0 ORDER BY CreatedDate DESC

IF (
	SELECT COUNT(ActivateDate)
	FROM OffenderTrackerActivation
	WHERE TrackerID = @TrackerID AND OffenderID = @OffenderID AND OfficerID = @OfficerID AND DeactivateDate IS NULL
	) = 0
BEGIN

INSERT INTO OffenderTrackerActivation
	(TrackerID, OffenderID, OfficerID, ActivateDate, ModifiedByID, IsDemo, BillableID)
VALUES
	(@TrackerID, @OffenderID, @OfficerID, @ActivateDate, @ModifiedByID, @IsDemo, @BillableID)

SET @TrackerActivationID = SCOPE_IDENTITY()

   
		INSERT INTO [trackerpal].[dbo].[OffenderServiceBilling]
					  ([Offenderid]
					  ,[StartDate]
					  ,[EndDate]
					  ,[BillingServiceOptionID]
					  ,[ServiceID]
					  ,[ReportingInterval]
					  ,[Cost]
					  ,[Active]
                  ,[Trackerid]
                  ,[IsDemo]
                  ,[Billableid])
		SELECT
						@Offenderid
						,@Activatedate
						,NULL
						,bso.id
						,isnull(cbs.serviceid,1)
						,sori.[Name]
						,bsori.Cost
						,1
                  ,@Trackerid
                  ,@IsDemo
						,@BillableId
		From Offender o
		LEFT JOIN dbo.OptionalBillingServiceOptionOffender obsoo ON obsoo.Offenderid = o.Offenderid
		LEFT JOIN Billingserviceoption bso ON bso.id = obsoo.BillingServiceOptionID
		LEFT JOIN dbo.BillingServiceOptionReportingInterval bsori ON bsori.BillingServiceOptionID = bso.ID
		LEFT JOIN dbo.refServiceOptionReportingInterval sori ON sori.id = bsori.ReportingIntervalID
		LEFT JOIN ClassicBillingservice cbs ON cbs.Billingserviceid = bso.billingserviceid
		Where o.Offenderid = @Offenderid

END














GO
GRANT EXECUTE ON [mTrackerActivate] TO [db_dml]
GO
