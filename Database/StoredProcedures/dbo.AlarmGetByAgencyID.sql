/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:26 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [AlarmGetByAgencyID]

	@StartDate		BIGINT,
	@EndDate		BIGINT,
	@EventTypeID	INT,
	@AgencyID		INT,
	@SO				INT,
	@OPR			INT,
	@EventTypeGroupID int 
	
AS
WITH Events_CTE
AS
(
SELECT *
FROM rprtEventsBucket2
WHERE EventTime BETWEEN @StartDate AND @EndDate AND AgencyID = @AgencyID
UNION
SELECT *
FROM rprtEventsBucket1
WHERE EventTime BETWEEN @StartDate AND @EndDate AND AgencyID = @AgencyID
)

SELECT * INTO #tmp FROM Events_CTE
SELECT
	a.AlarmID, 
	a.AlarmType AS 'AlarmTypeID', 
	a.EventTime,
	ISNULL(a.AlarmAssignmentStatusID,1) as 'AlarmAssignmentStatusID',
	ISNULL(a.AlarmAssignmentStatusName,'New') as 'AlarmAssignmentStatusName',
--	(
--		CASE
--			WHEN a.EventTypeID = 256 AND a.EventParameter > 0
--			THEN et.AbbrevEventType + ' ' + CONVERT(nvarchar(4),a.EventParameter)
--			ELSE et.AbbrevEventType
--		END
--	) AS 'EventName',
	a.EventName,
	ISNULL(ROUND(a.Longitude,5), 0) AS 'Longitude',
	ISNULL(ROUND(a.Latitude,5), 0) AS 'Latitude',
	ISNULL(a.Address, CONVERT(nvarchar(9),ISNULL(ROUND(a.Latitude,5), 0))+', '+CONVERT(nvarchar(9),ISNULL(ROUND(a.Longitude,5), 0)) ) AS 'Address',
--	ISNULL(o.FirstName + ' ', '') + 
--	ISNULL(o.MiddleName + ' ', '') + 
--	ISNULL(o.LastName, '') AS 'OffenderName',
	a.OffenderName,
	a.OffenderID,
	(SELECT COUNT (*) FROM AlarmNote WHERE AlarmID = a.AlarmID) AS 'NoteCount',
	ISNULL(a.GpsValid,0) AS 'GpsValid',
	ISNULL(a.GpsValidSatellites,0) AS 'GpsValidSatellites',
	a.DeviceID, 
	a.EventID,
	ISNULL(a.GeoRule,'N/A') AS GeoRule
    
FROM
#tmp a
--	[TrackerPal].[dbo].[fnEvents] ( @StartDate, @EndDate ) a
--	[fnEvents] ( [dbo].[ConvertLongToDate]( @StartDate ) , [dbo].[ConvertLongToDate]( @EndDate ) ) a
--	LEFT JOIN EventType et ON a.EventTypeID = et.EventTypeID
--	JOIN OffenderTrackerActivation ota ON ota.OffenderID = a.OffenderID AND ota.TrackerID =a.TrackerID 
--		AND ((ota.activateDate< a.EventDisplayTime AND ota.DeActivateDate> a.EventDisplayTime)
--			OR (ota.activateDate<a.EventDisplayTime AND ota.DeActivateDate IS NULL))
--	LEFT JOIN Offender o ON a.OffenderID = o.OffenderID
--	LEFT JOIN AlarmAssignment aa ON a.alarmId = aa.alarmid AND aa.AssignedDate = (SELECT MAX(AssignedDate) FROM AlarmAssignment AAD WHERE aad.AlarmID = a.AlarmID)
--	LEFT JOIN AlarmAssignmentStatus aas ON aas.AlarmAssignmentStatusID = aa.AlarmAssignmentStatusID 
--	LEFT JOIN GAteway.dbo.events e ON e.DeviceID = a.TrackerID AND e.EventTime = a.EventTime AND e. Eventid= a.eventtypeid
--	LEFT JOIN GeoRule gr ON gr.GeoRuleID = a.EventParameter
WHERE
	a.AlarmType > 1 AND
	a.AlarmID NOT IN (SELECT AlarmID FROM AlarmAcknowledgement) 
	AND ((@EventTypeID < 0) OR (a.EventID = @EventTypeID ))
--	AND (
--		(@StartDate = 0 AND @EndDate = 0)
--		OR
--		(a.EventTime >= @StartDate AND a.EventTime <= @EndDate)
--	)
--	AND ((@AgencyID = 0) OR (a.AgencyID = @AgencyID))
	AND ((@SO<0) OR (a.SO=@SO))
	AND ((@OPR<0) OR (a.OPR=@OPR))
	AND	(
		(@EventTypeGroupID < 0)
		OR
		(a.EventTypeGroupID = @EventTypeGroupID )
	)
ORDER BY
	a.EventTime DESC, a.AlarmType DESC

Drop Table #tmp
GO
GRANT EXECUTE ON [AlarmGetByAgencyID] TO [db_dml]
GO
GRANT VIEW DEFINITION ON [AlarmGetByAgencyID] TO [db_object_def_viewers]
GO
