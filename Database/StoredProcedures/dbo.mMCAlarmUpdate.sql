/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:27 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [mMCAlarmUpdate]    
  @AlarmID    INT,  
 @AlarmAssignmentStatusID  INT,  
 @AssignedToUserID   INT,  
 @AssignedByUserID   INT,  
 @OperatorName    nvarchar(50)  
  
AS  

 DECLARE @AlarmAssignmentID    INT  
 DECLARE @AlarmAssignmentStatusName varchar(50) 

 INSERT INTO AlarmAssignment  
 (AlarmID, AlarmAssignmentStatusID, AssignedToID, AssignedByID)  
 VALUES  
 (@AlarmID, @AlarmAssignmentStatusID, @AssignedToUserID, @AssignedByUserID);  
  
 SET @AlarmAssignmentID = @@IDENTITY;  
 
 SET @AlarmAssignmentStatusName = (SELECT AlarmAssignmentStatusName FROM AlarmAssignmentStatus 
					WHERE AlarmAssignmentStatusID = @AlarmAssignmentStatusID)

			UPDATE [dbo].[rprtEventsBucket1]
			SET AlarmAssignmentStatusID = @AlarmAssignmentStatusID,
				AlarmAssignmentStatusName = @AlarmAssignmentStatusName
			WHERE AlarmID = @AlarmID

			UPDATE [dbo].[rprtEventsBucket2]
			SET AlarmAssignmentStatusID = @AlarmAssignmentStatusID,
				AlarmAssignmentStatusName = @AlarmAssignmentStatusName
			WHERE AlarmID = @AlarmID


			UPDATE [dbo].[rprtEventsBucket1]
			SET AlarmAssignmentStatusID = @AlarmAssignmentStatusID,
				AlarmAssignmentStatusName = @AlarmAssignmentStatusName
			WHERE AlarmID in (select alarmid from rprtAlarmmonitorCentersubGrid
		where parentAlarmid = @AlarmID)

			UPDATE [dbo].[rprtEventsBucket2]
			SET AlarmAssignmentStatusID = @AlarmAssignmentStatusID,
				AlarmAssignmentStatusName = @AlarmAssignmentStatusName
			WHERE AlarmID in (select alarmid from rprtAlarmmonitorCentersubGrid
		where parentAlarmid = @AlarmID)


 if ((select count(*) from rprtAlarmMonitorCenterSubGrid WHERE ParentAlarmID=@AlarmID)>0)  
 BEGIN  
  --insert new records for all subalarms for this alarm  
    insert AlarmAssignment(AlarmID,AlarmAssignmentStatusID,AssignedToID,AssignedByID)   
     select ALarmID,@AlarmAssignmentStatusID,@AssignedToUserID,@AssignedByUserID   
     from rprtAlarmMonitorCenterSubGrid WHERE ParentAlarmID=@AlarmID  
  end

     
  
  
 IF(@AlarmAssignmentStatusID = 4) 
	BEGIN
	
	UPDATE Alarm 
		SET AlarmGroupID=(SELECT AlarmGroupID from rprtAlarmmonitorCenterGrid 
				where alarmid=@AlarmID)
		WHERE  AlarmID=@AlarmID
	
	UPDATE Alarm 
		SET AlarmGroupID=
			(SELECT AlarmGroupID from rprtAlarmmonitorCenterGrid
				where alarmid=@AlarmID)
		WHERE  AlarmID in (select alarmid from rprtAlarmmonitorCentersubGrid
		where parentAlarmid = @AlarmID)
	
	DELETE FROM rprtAlarmmonitorCentersubGrid where parentAlarmid = @AlarmID
	DELETE  FROM dbo.rprtAlarmMonitorCenterGrid WHERE AlarmID=@AlarmID
		

	END
 ELSE
	BEGIN
		UPDATE rprtAlarmMonitorCenterGrid   
		SET AlarmAssignmentStatusID=@AlarmAssignmentStatusID,    
		OperatorName=@operatorName,  
		AssignedDate=(getdate()),  
		OperatorUserID=@AssignedToUserID  
		WHERE  rprtAlarmMonitorCenterGrid.AlarmID=@AlarmID  
	END




GO
GRANT EXECUTE ON [mMCAlarmUpdate] TO [db_dml]
GO
