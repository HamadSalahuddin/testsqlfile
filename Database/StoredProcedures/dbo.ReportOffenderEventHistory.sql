/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:27 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [ReportOffenderEventHistory]

	@StartDate		BigInt,
	@EndDate		BigInt,
	@TrackerID		INT,
	@SO				INT,
	@OPR			INT,
	@TimeZoneOffset INT
	
AS
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
SELECT
                        ag.Agency,
                        ISNULL(o.FirstName + ' ', '') +
                        ISNULL(o.MiddleName + ' ', '') +
                        ISNULL(o.LastName, '') AS 'OfficerName',
                        ISNULL(o.FirstName + ' ', '') + 
                        ISNULL(o.MiddleName + ' ', '') +
                        ISNULL(o.LastName, '') AS 'OffenderName',
                        t.TrackerNumber,
                        (DATEADD ( mi, @TimeZoneOffset, (Convert(DateTime,
                        (DATEADD(ms, (e.EventTime / CAST(10000 AS bigint)) % 86400000,
                        DATEADD(day, e.EventTime / CAST(864000000000 AS bigint) - 109207, 0)))
                        )))) as EventTime,
                        et.AbbrevEventType as EventName,
--                      g.GeoRuleName,
						(
							CASE
								WHEN et.EventTypeGroupID = 5
								THEN g.GeoRuleName 
								ELSE 'N/A'
							END
						) AS 'GeoRuleName',
                        ISNULL(ROUND(e.Longitude,5), 0) AS 'Longitude',
                        ISNULL(ROUND(e.Latitude,5), 0) AS 'Latitude',
						e.StreetAddress AS Address,
                        e.Speed,
                        e.Heading,
                        aa.AssignedDate as OperatorAccepted,
                        Isnull(u.UserName,'') as Operator,
                        e.GpsValid,
                        e.GpsValidSatellites,
                        e.InternalBatteryVoltage,
                        e.ExternalBatteryVoltage,
                        Convert(BIGINT,DATEDIFF(ss,e.ReceivedTime ,
                        DATEADD ( mi, @TimeZoneOffset, (Convert(DateTime,
                        (DATEADD(ms, (e.EventTime / CAST(10000 AS bigint)) % 86400000,
                        DATEADD(day, e.EventTime / CAST(864000000000 AS bigint) - 109207, 0)))
                        ))))) as latency,
                        ROUND(e2.latitude,5) AS 'LastLatitude',
                        ROUND(e2.longitude,5) AS 'LastLongitude',
                        e.latitude,
                        e.longitude

        FROM    Gateway.dbo.Events e
        LEFT JOIN EventType et ON e.EventID = et.EventTypeID
        left join Gateway.dbo.EventTypes ge on ge.Eventid = et.EventTypeID
        LEFT JOIN Alarm a ON 
                                        e.DeviceID = a.TrackerID AND
                                        e.EventTime = a.EventTime AND
                                        e.EventID = a.EventTypeID
        lEFT jOIN Georule g on g.GeoruleId = e.EventParameter
        LEFT JOIN Offender o on o.OffenderID = a.OffenderID
        left join AlarmAssignment aa on a.alarmId = aa.alarmid AND aa.AssignedDate = (SELECT Min(AssignedDate) FROM AlarmAssignment AAD WHERE aad.AlarmID = a.AlarmID)
        left join [user] u on u.userid= aa.AssignedByID
        left join tracker t on t.Trackerid = e.DeviceID
        left join agency ag on ag.AgencyID = o.AgencyID
        left join Gateway.dbo.Events e2 on e2.deviceid= e.deviceid and e2.eventtime = (select max(e3.eventtime) from Gateway.dbo.Events e3 where e3.deviceid= e2.deviceid and e3.eventtime<e.eventtime )
        Where
                (
                        (@StartDate = 0 AND @EndDate = 0)
                        or
                        (
                                (e.EventTime >= @StartDate)
                                AND
                                (e.EventTime <= @EndDate)
                        )
                )
                and
                (
                        (@TrackerID = 0)
                        or
                        (e.DeviceID = @TrackerID)
                )
                and (
                                (@SO<0)
                                or
                                 (et.SO=@SO)
                        )
                and (
                                (@OPR<0)
                                or
                                (et.OPR=@OPR)
                        )
        
        
ORDER BY e.EventTime DESC, ge.AlarmType
GO
GRANT VIEW DEFINITION ON [ReportOffenderEventHistory] TO [db_object_def_viewers]
GO
GRANT EXECUTE ON [ReportOffenderEventHistory] TO [db_dml]
GO
