/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:28 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [spOffenderAlarmHistory]
@StartDate DateTime,
@EndDate Datetime,
@Agencyid INT,
@Offenderid INT

AS

SELECT TOP 5000
e.Offendername AS 'Offender',
	ISNULL(so.FirstName + ' ', '') + 
	ISNULL(so.LastName, '') AS 'Officer',
	ag.Agency,
	trackerpal.dbo.fnUtcToLocal(@AgencyID,e.eventdatetime) AS 'Event Time', 
   e.EventNAme AS'Event Name',
	e.Georule AS 'Geo Rule',
	    
    (CASE WHEN e.Gpsvalid != 1 and e.GpsValidSatellites != 1 THEN 'Unavailable'
     ELSE e.Address END) AS 'Location',
	case when dbo.fnIsAlarmAutoCompleted(a.AlarmID) > 0 then
		trackerpal.dbo.fnUtcToLocal(@AgencyID,aa2.AssignedDate)
	else
		trackerpal.dbo.fnUtcToLocal(@AgencyID,aa.AssignedDate)  		
	END as 'Accepted Date',
		ISNULL(oa.FirstName + ' ', '') + 
		ISNULL(oa.MiddleName + ' ', '') + 
		ISNULL(oa.LastName, '')
     AS 'Accepted By',
   (CASE WHEN op.userid is NULL AND ofi.userid is NULL THEN 'N/A'
    WHEN op.userid is NULL THEN 
    ofi.FirstName+' '+ofi.LastName
    ELSE op.FirstNAme+' '+op.LastName END)AS 'Note Author',  
   an.Note
 
	
FROM
	Alarm a  With(NOLOCK)
   JOIN [dbo].[EventBuckets] e ON e.alarmid = a.alarmid
	LEFT JOIN Officer so WITH(NOLOCK) ON so.OfficerID = e.OfficerID
	LEFT JOIN Agency ag WITH(NOLOCK) ON ag.AgencyID = e.AgencyID
	LEFT JOIN AlarmAssignment aa WITH(NOLOCK) on a.alarmId = aa.alarmid AND aa.AssignedDate = 
	(
		SELECT MAX(AssignedDate) FROM AlarmAssignment AAD WITH(NOLOCK) WHERE aad.AlarmID = a.AlarmID and aad.alarmassignmentStatusID = 2
	) 
	and  aa.alarmassignmentStatusID = 2
	LEFT JOIN AlarmAssignment aa2 WITH(NOLOCK) on a.alarmId = aa2.alarmid AND aa2.AssignedDate = 
	(
		SELECT MAX(AssignedDate) FROM AlarmAssignment AAD2 WITH(NOLOCK) WHERE aad2.AlarmID = a.AlarmID and aad2.alarmassignmentStatusID = 4
	) 
	and  aa.alarmassignmentStatusID = 4
	JOIN AlarmNote an ON an.alarmid = a.alarmid
	LEFT JOIN operator oa WITH(NOLOCK) on aa.AssignedToID = oa.userid
	LEFT JOIN operator op on AN.CreatedByid = op.userid
   LEFt JOIN Officer ofi ON ofi.Officerid = AN.CreatedByid
   JOIN Timezone tz ON tz.Timezoneid = ag.Timezoneid
WHERE
DATEADD(mi,tz.daylightutcoffset,a.Eventdisplaytime) >=@StartDate 
	AND 
	
  DATEADD(mi,tz.daylightutcoffset,a.Eventdisplaytime)<= @EndDate
	and a.OffenderID = @OffenderID
	AND ( e.SO = 1)/*only the events that are available to So*/
ORDER BY a.EventDisplayTime asc, e.AlarmType

GO
GRANT EXECUTE ON [spOffenderAlarmHistory] TO [db_dml]
GO
