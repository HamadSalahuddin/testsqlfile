/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:27 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [OffenderGetLastAlarm]

	@OffenderID	INT,
	@SO			INT,
	@OPR		INT

AS


		SELECT	top 1 
				a.EventTypeID AS 'StatusID',
				et.AbbrevEventType  AS 'EventType',
				a.AlarmID,
				a.EventTime AS 'LastEventTime',
                a.EventDisplayTime AS 'LastEventDisplayTime'		
		
		FROM  Alarm a 
 		JOIN EventType et ON a.EventTypeID = et.EventTypeID 
		join OffenderTrackerActivation ota on ota.OffenderID = a.OffenderID and ota.TrackerID =a.TrackerID AND(
			 (ota.activateDate< a.EventDisplayTime
			 and ota.DeActivateDate> a.EventDisplayTime)
			or
			(ota.activateDate<a.EventDisplayTime
			 and ota.DeActivateDate is null))
	WHERE	a.OffenderID = @OffenderID 	
				and (
					(@SO<0)
					or
					 (et.SO=@SO)
				)
				and (
					(@OPR<0)
					or
					(et.OPR=@OPR)
				)
				
	ORDER BY a.eventtime desc
GO
GRANT VIEW DEFINITION ON [OffenderGetLastAlarm] TO [db_object_def_viewers]
GO
GRANT EXECUTE ON [OffenderGetLastAlarm] TO [db_dml]
GO
