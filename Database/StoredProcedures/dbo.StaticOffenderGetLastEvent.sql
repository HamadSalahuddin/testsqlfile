/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:28 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [StaticOffenderGetLastEvent]

	@OffenderID	INT

AS
	
IF EXISTS (SELECT	top 1 EventPrimaryID FROM rprtEventsBucket1 e WHERE e.OffenderID=@OffenderID )
BEGIN
	--check bucket 1
	SELECT * FROM  
		(SELECT TOP 1 * FROM rprtEventsBucket1 e WITH (NOLOCK) WHERE e.OffenderID=@OffenderID 
	ORDER BY e.eventdatetime desc
		) as e2
 		JOIN EventType et ON e2.EventID = et.EventTypeID 
END 
--ELSE
--BEGIN
----	--check bucket 2
----	SELECT * FROM  
----		(
----		SELECT TOP 1 * FROM rprtEventsBucket2 e WITH (NOLOCK)
------(INDEX(INDX_rptEventsBucket2_offenderid_Name_Deleted),NOLOCK) 
----WHERE e.OffenderID=@OffenderID 
----       ANd EventDateTiME > DATEADD(wk,-3,GETDATE())
----		ORDER BY e.eventDatetime desc
----		) as e2
---- 		JOIN EventType et ON e2.EventID = et.EventTypeID 
--	
--END

--Select Top 1
--e.*
--From Gateway.dbo.devices d
--JOIN fnallevents () e ON e.deviceid = d.deviceid and d.lasteventtime = e.eventtime
----LEFT JOIN gateway.dbo.events ev ON ev.eventtime = d.Lasteventtime
--JOIN Offendertrackeractivation ota ON ota.trackerid = d.deviceid
--Where ota.deactivatedate is NULL And e.Offenderid = @Offenderid
--END












GO
GRANT EXECUTE ON [StaticOffenderGetLastEvent] TO [db_dml]
GO
GRANT VIEW DEFINITION ON [StaticOffenderGetLastEvent] TO [db_object_def_viewers]
GO
