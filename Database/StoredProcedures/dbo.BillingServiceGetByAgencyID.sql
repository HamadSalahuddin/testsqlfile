/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:27 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [BillingServiceGetByAgencyID] @AgencyID INT
AS    
    
--Procedure returns data about and Agencies billing services.    
    
SET NOCOUNT ON;    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;    
    
--Get the data from Active, Passive and Passive+ services    
SELECT b.ID BillingServiceID, t.BillingServiceTypeName,b.BillingServiceTypeID, o.ID BillingServiceOptionID            
, o.IsRequired, o.IsOptional, bor.ReportingIntervalID, rs.[Name],rs.timeSeconds,bor.Cost,rs.DisplayOrder,            
es.ID as eArrestServiceID, es.BeaconLimit, es.PricePerBeacon,StartDateTime, cs.ServiceID, null as Rate           
FROM dbo.BillingService b             
INNER JOIN dbo.refBillingServiceType t ON t.ID = b.BillingServiceTypeID            
inner JOIN dbo.BillingServiceOption o ON b.ID = o.BillingServiceID            
INNER JOIN dbo.BillingServiceOptionReportingInterval bor ON o.ID = bor.BillingServiceOptionID            
INNER JOIN dbo.refServiceOptionReportingInterval rs ON bor.ReportingIntervalID = rs.ID            
inner JOIN dbo.ClassicBillingService cs ON b.ID = cs.BillingServiceID            
LEFT JOIN dbo.EArrestService es ON cs.ID = es.ClassicBillingServiceID            
WHERE b.AgencyID  = @AgencyID
UNION    
--Get the data from Earrest service    
SELECT b.ID BillingServiceID, t.BillingServiceTypeName,b.BillingServiceTypeID, null BillingServiceOptionID            
, null IsRequired, null IsOptional,null ReportingIntervalID, null [Name],null timeSeconds,null Cost,NULL DisplayOrder,             
es.ID as eArrestServiceID, es.BeaconLimit, es.PricePerBeacon,StartDateTime, cs.ServiceID, es.Rate         
FROM dbo.BillingService b             
INNER JOIN dbo.refBillingServiceType t ON t.ID = b.BillingServiceTypeID            
inner JOIN dbo.ClassicBillingService cs ON b.ID = cs.BillingServiceID            
LEFT JOIN dbo.EArrestService es ON cs.ID = es.ClassicBillingServiceID            
WHERE    
cs.ServiceID=4 and    
b.AgencyID  = @AgencyID
ORDEr BY rs.Displayorder


GO
GRANT EXECUTE ON [BillingServiceGetByAgencyID] TO [db_dml]
GO
