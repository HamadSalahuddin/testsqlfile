/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:27 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [OffenderGetAllByAgIDOffIDClassicServ]     
@AgencyID INT,    
@OfficerID INT,    
@RoleID  INT ,  
@UserID INT=-1   
  
AS    
  
IF @RoleID <> 6      
BEGIN   
SELECT distinct o.OffenderID  ,    ISNULL(o.LastName + ', ', '') + ISNULL(o.FirstName, '') AS 'OffenderName', o.LastName, o.FirstName  
FROM Offender o  (NOLOCK)       
left JOIN Offender_Officer  oo (NOLOCK) ON o.OffenderID = oo.OffenderID       
left JOIN dbo.OffenderOptionalBillingService offs ON o.OffenderID = offs.OffenderID  
left join dbo.ClassicBillingService cbs on cbs.billingServiceId = offs.BillingServiceid  
left join dbo.earrestservice ea on ea.ClassicBillingServiceid = cbs.id 
left join dbo.BillingService bs on bs.AgencyID = o.AgencyID 
--and billingservicetypeid=1  
left join dbo.ClassicBillingService cbs2 on cbs2.billingServiceId = bs.id  
left join dbo.earrestservice ea2 on ea2.ClassicBillingServiceid = cbs2.id 
  
WHERE(      (       (@RoleID = 2 OR @RoleID = 3)         
AND        (o.AgencyID = @AgencyID)      )  
      OR       (       (        (@AgencyID<=0)          
or        (o.AgencyID = @AgencyID)       )         
AND(        (@OfficerID<=0)        
  or        (oo.OfficerID = @OfficerID)       )      )     )             
 AND o.Deleted = 0 AND o.Victim = 0      
and (
	(cbs2.ID is not null and ea2.id is null ) 
	or
	 (cbs.ID is not null  and ea.id is null )  
	)
 
ORDER BY o.LastName, o.FirstName     
end  
ELSE   
  BEGIN     
 SELECT distinct o.OffenderID  , de.UserID,    ISNULL(o.LastName + ', ', '') + ISNULL(o.FirstName, '') AS 'OffenderName',   o.LastName, o.FirstName   
 FROM Offender o  (NOLOCK)      
INNER JOIN agency a on o.AgencyID = a.AgencyID      
INNER JOIN distributoremployee de on a.DistributorID=de.DistributorID AND de.UserID=@UserID      
left JOIN dbo.OffenderOptionalBillingService offs ON o.OffenderID = offs.OffenderID  
left join dbo.ClassicBillingService cbs on cbs.billingServiceId = offs.BillingServiceid  
left join dbo.earrestservice ea on ea.ClassicBillingServiceid = cbs.id 
left join dbo.BillingService bs on bs.AgencyID = o.AgencyID and billingservicetypeid=1  
left join dbo.ClassicBillingService cbs2 on cbs2.billingServiceId = bs.id  
left join dbo.earrestservice ea2 on ea2.ClassicBillingServiceid = cbs2.id 
WHERE o.Deleted = 0 AND o.Victim = 0    
and (
	(cbs2.ID is not null and ea2.id is null ) 
	or
	 (cbs.ID is not null  and ea.id is null )  
	)  ORDER BY o.LastName, o.FirstName       
END    




GO
GRANT EXECUTE ON [OffenderGetAllByAgIDOffIDClassicServ] TO [db_dml]
GO
