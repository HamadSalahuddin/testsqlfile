/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:27 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [AlarmGetUnassignedAlarms]

AS
BEGIN
	SET NOCOUNT ON;

	SELECT a.AlarmID, a.OffenderID, a.TrackerID, a.EventTypeID, a.EventTime, ROUND(a.Latitude,5), ROUND(a.Longitude,5)
	FROM Alarm a
		LEFT JOIN AlarmAssignment ASN on a.AlarmID=ASN.AlarmID
		LEFT JOIN AlarmAcknowledgement ACK on a.AlarmID=ACK.AlarmID
		JOIN OffenderTrackerActivation ota on ota.OffenderID = a.OffenderID and ota.TrackerID =a.TrackerID AND(
				(ota.activateDate< a.EventDisplayTime
				and ota.DeActivateDate> a.EventDisplayTime)
				or
				(ota.activateDate<a.EventDisplayTime
				and ota.DeActivateDate is null))
	WHERE  ASN.AlarmID is null and ACK.AlarmID is null AND
		   a.OffenderID != 0

END
GO
GRANT EXECUTE ON [AlarmGetUnassignedAlarms] TO [db_dml]
GO
GRANT VIEW DEFINITION ON [AlarmGetUnassignedAlarms] TO [db_object_def_viewers]
GO
