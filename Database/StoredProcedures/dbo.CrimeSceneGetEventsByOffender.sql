/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:27 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [CrimeSceneGetEventsByOffender]

	
 @StartDate datetime,
 @EndDate datetime,
 @Proximity float,
 @Latitude  float,
 @Longitude float,
 @OffenderID int,
 @TimeZoneOffset int,
 @PointID int,
 @AgencyID int

AS
Select * INTO #tmpevents
from Fnallevents ()
where EventDateTime >= @StartDate and EventDateTime <= @EndDate and OffenderID =@OffenderID


Select distinct e.EventID,e.OffenderID,a.Agency, 
ISNULL(o.LastName + ', ', '') + ISNULL(o.FirstName, '') AS 'OfficerName',
case 
	when a.AgencyID <> @AgencyID then ISNULL(oe.CaseNumber, ' ')
	else e.OffenderName
end as 'OffenderName',
case when e.Address is null 
then 'Lat. ' + cast(e.latitude as nvarchar) +', Long. ' +cast(e.longitude as nvarchar)
else e.Address
end as 'Address', 
(DATEADD ( mi, @TimeZoneOffset, (Convert(DateTime,
                        (DATEADD(ms, (e.EventTime / CAST(10000 AS bigint)) % 86400000,
                        DATEADD(day, e.EventTime / CAST(864000000000 AS bigint) - 109207, 0)))
                        )))) AS 'EventDateTime',
e.latitude,e.Longitude,@PointID as 'PointID',e.TrackerNumber,a.AgencyID
--from [fnEvents] ( @StartDate, @EndDate ) e  
from #tmpevents e
--Fnallevents () e
--[fnEvents] ( @StartDate, @EndDate) e --[fnAllEvents] () e
join Agency a on e.AgencyId = a.AgencyID 
join Officer o on o.OfficerID =e.OfficerID
join offender oe on oe.offenderID = @OffenderID
where e.EventDateTime >= @StartDate and e.EventDateTime <= @EndDate and e.OffenderID =@OffenderID 
and trackerPAL.dbo.[fnGetDistance](e.latitude,e.longitude,@Latitude,@Longitude) < @Proximity
order by EventDateTime DESC

Drop table #tmpevents





GO
GRANT EXECUTE ON [CrimeSceneGetEventsByOffender] TO [db_dml]
GO
GRANT VIEW DEFINITION ON [CrimeSceneGetEventsByOffender] TO [db_object_def_viewers]
GO
