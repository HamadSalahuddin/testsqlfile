/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:27 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [BillingServiceAdd] 
@CreatedByID INT, 
@CreatedDate DATETIME, 
@AgencyID INT, 
@StartDateTime DATETIME, 
@BillingServiceTypeID INT, 
@NumberOfBeacons INT,
@Price FLOAT,
@IsEArrest BIT,
@ServiceID INT,
@Rate FLOAT,
@NewID INT OUTPUT
AS

DECLARE @ClassicID INT;
--Adds new Billing Service record to BillingService.
SET NOCOUNT ON;

--Check for latent transcations.
IF @@TRANCOUNT > 0
	BEGIN
		ROLLBACK TRANSACTION
	END;

BEGIN TRANSACTION;
BEGIN TRY

	INSERT INTO dbo.BillingService(CreatedByID,CreatedDate,AgencyID,StartDateTime, BillingServiceTypeID)
	VALUES(@CreatedByID,@CreatedDate,@AgencyID,@StartDateTime,@BillingServiceTypeID)
	SET @NewID = SCOPE_IDENTITY();

	INSERT INTO dbo.ClassicBillingService(BillingServiceID,ServiceID)
	VALUES(@NewID,@ServiceID)
	SET @ClassicID = SCOPE_IDENTITY();

	IF (@IsEArrest = 1)
	BEGIN
			INSERT INTO dbo.EArrestService(ClassicBillingServiceID,PricePerBeacon,BeaconLimit,Rate)
			VALUES(@ClassicID,@Price,@NumberOfBeacons,@Rate)
	END
END TRY
BEGIN CATCH
	--Catch and return error.
    SELECT 
        ERROR_NUMBER() AS ErrorNumber,
        ERROR_SEVERITY() AS ErrorSeverity,
        ERROR_STATE() as ErrorState,
        ERROR_PROCEDURE() as ErrorProcedure,
        ERROR_LINE() as ErrorLine,
        ERROR_MESSAGE() as ErrorMessage;
	--Rollback outstanding transactions.
	IF @@TRANCOUNT > 0
		BEGIN
			ROLLBACK TRANSACTION
		END;
END CATCH;

IF @@TRANCOUNT > 0
	BEGIN
		COMMIT TRANSACTION
	END;



GO
GRANT EXECUTE ON [BillingServiceAdd] TO [db_dml]
GO
