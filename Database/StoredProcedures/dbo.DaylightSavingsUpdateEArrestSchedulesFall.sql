/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:27 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
-- =============================================
-- Author:		Rick Bertelsen
-- Create date: Oct. 23,  2008
-- Description:	Daylight Savings Time eArrest
-- =============================================
CREATE PROCEDURE [DaylightSavingsUpdateEArrestSchedulesFall] 
	-- Add the parameters for the stored procedure here
	@RuleID int, 
	@FileID int,
	@OffenderID int,
	@TrackerID int
 
AS
DECLARE @RowCount			int
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	IF (0 = (SELECT COUNT(*) FROM DayLightUpdateProgressEArrest (NOLOCK)
				WHERE	TrackerID = @TrackerID
					AND	OffenderID = @OffenderID
					AND RuleID = @RuleID))
	BEGIN
		UPDATE Schedule WITH (ROWLOCK)
			SET StartDateTime = DATEADD(MI, 60, StartDateTime),
				EndDateTime = DATEADD(MI, 60, EndDateTime)
			WHERE	RuleID = @RuleID
				AND	AlwaysOn = 0
		SELECT @RowCount = @@Rowcount
		IF (@Rowcount > 0)
		BEGIN
			INSERT DayLightUpdateProgressEArrest
				(TrackerID, OffenderID, FileID, RuleID, GeoRuleScheduleUpdatedTime)
				VALUES
				(@TrackerID, @OffenderID, @FileID, @RuleID, GETDATE())
		END
	END	

END

GO
GRANT EXECUTE ON [DaylightSavingsUpdateEArrestSchedulesFall] TO [db_dml]
GO
