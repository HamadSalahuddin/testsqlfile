/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:28 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [TrackerGetByAgencyIDOffenderIDVersion]

	@AgencyID		int = -1,
	@OffenderID		int = 0,
	@GatewayPort	varchar(10),
	@GatewayIp		varchar(20),
    @VersionName    varchar(50)=''

AS

SELECT	
	t.[TrackerID],[TrackerNumber]--,[AgencyID],t.[CreatedDate],[CreatedByID],[ModifiedDate],[ModifiedByID],[Deleted],[RmaID]
FROM	
	[Tracker] t
	LEFT JOIN [TrackerAssignment] ta ON ta.TrackerAssignmentID = 
	(
		SELECT MAX(TrackerAssignmentID) -- MAX(AssignmentDate) -- 
		FROM [TrackerAssignment] ta 
		WHERE ta.TrackerID = t.TrackerID
	)
	LEFT JOIN Gateway.dbo.DeviceProperties dp1 ON dp1.DeviceID = t.TrackerID AND dp1.propertyID = '8410'
	LEFT JOIN Gateway.dbo.DeviceProperties dp2 ON dp2.DeviceID = t.TrackerID AND dp2.propertyID = '8411'
    LEFT JOIN dbo.TrackerVersion tv ON tv.ID=t.TrackerVersion
WHERE	
	t.Deleted = 0 
	AND RmaID IS NULL 

	-- Devices for all agencies OR for specified agency.
	AND (@AgencyID = -1 OR t.AgencyID = @AgencyID) 

	AND 
	(
		-- All unassigned devices
		TrackerAssignmentTypeID IS NULL OR TrackerAssignmentTypeID = 2  
		OR
		-- (the OR operator joins in this case) any device currently assigned to the specified offender.
		(TrackerAssignmentTypeID = 1 AND ta.OffenderID = @OffenderID)
	)	

	AND (dp1.PropertyValue = @GatewayIp AND dp2.PropertyValue = @GatewayPort)
	AND (dp1.PropertyValue = @GatewayIp AND dp2.PropertyValue = @GatewayPort)
	and (tv.VersionName=@VersionName or @VersionName='') 
	
	ORDER BY TrackerNumber
	


GO
GRANT EXECUTE ON [TrackerGetByAgencyIDOffenderIDVersion] TO [db_dml]
GO
