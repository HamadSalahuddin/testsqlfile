/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:28 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [spprotocolhistory]
@Offenderid int,
@eventid int
As
Select 
aps.alarmprotocolsetname
,o.FirstName +' '+o.LastNAme AS 'Offender Name'
,DATEADD(mi,tz.daylightutcoffset,apc.ModifiedDate) As 'Modified Date'
,(CASE WHEN apc.modifiedbyid NOT IN (Select userid from operator)
   THEN ofi.FirstName+' '+ofi.LastName
   ELSE opr.FirstNAme +' '+opr.LastNAme ENd) AS 'Modified By'
,ape.AlarmName
,apc.OriginalValues
,apc.NewValues
FROM Offender o
JOIN Offender_Alarmprotocolset oa ON oa.Offenderid = o.Offenderid
JOIN AlarmProtocolAction apa ON apa.alarmprotocolsetid = oa.alarmprotocolsetid and apa.deleted = 0
JOIN AlarmProtocolSET aps ON aps.alarmprotocolsetid = apa.Alarmprotocolsetid
JOIN AlarmprotocolEvent ape ON ape.alarmprotocoleventid = apa.alarmprotocoleventid
JOIN dbo.AlarmProtocolChangeLog apc ON apa.alarmprotocolactionid = apc.alarmprotocolactionid
LEFT JOIN Operator opr ON opr.userid = apc.modifiedbyid
LEFT JOIN officer ofi ON ofi.userid = apc.modifiedbyid
JOIN timezone tz on tz.timezoneid = 8

Where o.offenderid = @Offenderid And ape.alarmprotocoleventid = @Eventid


GO
GRANT EXECUTE ON [spprotocolhistory] TO [db_dml]
GO
