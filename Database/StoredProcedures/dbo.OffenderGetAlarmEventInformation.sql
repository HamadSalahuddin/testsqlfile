/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:27 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [OffenderGetAlarmEventInformation]  
  
 @OffenderID INT,  
 @AlarmID INT  
  
AS  
BEGIN  
 SET NOCOUNT ON;  
  
 SELECT TOP 1  
  ISNULL(o.FirstName, '') + ' ' + ISNULL(o.MiddleName, '') + ' ' + ISNULL(o.LastName, '') AS 'OffenderName',  
  ISNULL(o.CaseNumber, '') AS CaseNumber,  
  ISNULL(t.TrackerNumber, '') As TrackerNumber,  
  ISNULL(f.FirstName, '') + ' ' + ISNULL(f.MiddleName, '') + ' ' + ISNULL(f.LastName, '') AS 'OfficerName',  
  f.DayPhone,  
  f.EveningPhone,  
  f.MobilePhone,  
  f.EmailAddress1,  
  f.EmailAddress2,  
--  ISNULL(P.PropertyValue, '') AS PhoneNumber,  
--  ISNULL(P2.PropertyValue, '') AS PhoneNumber1,  
--  ISNULL(d.PhoneNumber, '') AS PhoneNumber2,  
  ISNULL(d.[Name], '') AS 'DeviceFriendlyName',  
        ISNULL(pl.[PrimaryLanguage], '') AS 'PrimaryLanguage',  
  ISNULL(f.ExtDayPhone, '') AS 'ExtDayPhone',  
        ISNULL(f.ExtEveningPhone, '') AS 'ExtEveningPhone',  
  t.TrackerID, 
  ag.Agency,
  a.address  
 FROM Offender o  
  LEFT JOIN Alarm a ON a.OffenderID = @OffenderID AND a.AlarmID = @AlarmID  
--  LEFT JOIN OffenderTrackerActivation ota ON ota.OffenderID = @OffenderID AND   
--   ota.ActivateDate =   
--   (  
--    SELECT TOP (1) ActivateDate   
--    FROM OffenderTrackerActivation   
--    WHERE ActivateDate <= a.EventDisplayTime  
--    ORDER BY ActivateDate DESC  
--   )  
  LEFT JOIN Tracker t ON t.TrackerID = a.TrackerID    
  LEFT JOIN Offender_Officer oo ON oo.OffenderID = @OffenderID  
  LEFT JOIN Officer f ON oo.OfficerID = f.OfficerID    
  LEFT JOIN Gateway.dbo.Devices d ON d.deviceID = t.TrackerID 
  LEFT JOIN Agency ag ON o.agencyid = ag.agencyid 
--  LEFT JOIN Gateway.dbo.DeviceProperties P ON P.DeviceID = t.TrackerID AND P.PropertyID = '8203'  
--  LEFT JOIN Gateway.dbo.DeviceProperties P2 ON P2.DeviceID = t.TrackerID AND P2.PropertyID = '8206'  
  LEFT JOIN PrimaryLanguage pl ON pl.PrimaryLanguageID = o.PrimaryLanguageID    
 WHERE o.OffenderID = @OffenderID  
-- ORDER BY ota.ActivateDate DESC  
END
GO
GRANT EXECUTE ON [OffenderGetAlarmEventInformation] TO [db_dml]
GO
GRANT VIEW DEFINITION ON [OffenderGetAlarmEventInformation] TO [db_object_def_viewers]
GO
