/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:27 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [AlarmGetByAlarmID]
	@iAlarmID int,
	@SO		int,
	@OPR	int

AS
BEGIN
        SET NOCOUNT ON;

           SELECT
                a.AlarmID,
                a.AlarmType AS 'AlarmTypeID',
                a.EventTime,
                ISNULL(a.AlarmAssignmentStatusID,0) AS 'AlarmAssignmentStatusID',
                ISNULL(Convert(nvarchar(25),a.AlarmAssignmentStatusName,0),'Unassigned') as 'AlarmAssignmentStatusName',
--              (
--                      CASE
--                              WHEN a.EventTypeID = 256 AND a.EventParameter > 0
--                              THEN et.AbbrevEventType + ' ' + CONVERT(nvarchar(4),a.EventParameter)
--                              ELSE et.AbbrevEventType
--                      END
--              ) AS 'EventName',
                a.EventName,
                ISNULL(ROUND(a.Longitude,5), 0) AS 'Longitude',
                ISNULL(ROUND(a.Latitude,5), 0) AS 'Latitude',
                ISNULL(a.Address, CONVERT(nvarchar(9),ISNULL(ROUND(a.Latitude,5), 0))+', '+CONVERT(nvarchar(9),ISNULL(ROUND(a.Longitude,5), 0)) ) AS 'Address',
--              ISNULL(o.FirstName + ' ', '') +
--              ISNULL(o.MiddleName + ' ', '') +
--              ISNULL(o.LastName, '') AS 'OffenderName',
                a.OffenderName,
                a.OffenderID,
                (SELECT COUNT (*) FROM AlarmNote WHERE AlarmID = a.AlarmID) AS 'NoteCount',
				ISNULL(a.GpsValid,0) AS 'GpsValid',
				ISNULL(a.GpsValidSatellites,0) AS 'GpsValidSatellites',
                a.DeviceID,
                a.EventID,
                (
                        CASE
                                WHEN a.EventTypeGroupID =5
                                THEN a.GeoRule
                                ELSE 'N/A'
                        END
                ) AS 'GeoRule'
				
        FROM
                [fnAllEvents] () a
--              LEFT JOIN EventType et ON a.EventTypeID = et.EventTypeID
--              LEFT JOIN Offender o ON a.OffenderID = o.OffenderID
--              LEFT JOIN AlarmAssignment aa on a.alarmId = aa.alarmid AND aa.AssignedDate = (SELECT MAX(AssignedDate) FROM AlarmAssignment AAD WHERE aad.AlarmID = a.AlarmID)
--              LEFT JOIN AlarmAssignmentStatus aas on aas.AlarmAssignmentStatusID = aa.AlarmAssignmentStatusID
--              LEFT JOIN GAteway.dbo.events e on e.DeviceID = a.TrackerID and e.EventTime = a.EventTime and e. Eventid= a.eventtypeid
--              LEFT JOIN GeoRule gr ON gr.GeoRuleID = a.EventParameter
        WHERE
				a.AlarmType > 1 AND
                a.AlarmID = @iAlarmID
                AND ((@SO<0) OR (a.SO=@SO))
                AND ((@OPR<0) OR (a.OPR=@OPR))
END


GO
GRANT VIEW DEFINITION ON [AlarmGetByAlarmID] TO [db_object_def_viewers]
GO
GRANT EXECUTE ON [AlarmGetByAlarmID] TO [db_dml]
GO
