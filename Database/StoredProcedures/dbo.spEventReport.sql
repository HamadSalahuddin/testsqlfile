/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:27 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [spEventReport]
	@value1 as nvarchar(max),
	@value2 as nvarchar(max),
	@StartDate as nvarchar(200),
	@EndDate as nvarchar(200)

AS
BEGIN
	
SET NOCOUNT ON;
declare @tempSql as nvarchar(max)
set @tempSql = 'Select DISTINCT ' + @value1 + ' from'

declare @sql nvarchar(max)

--set @sql = ' (SELECT DISTINCT et.AbbrevEventType as EventType, Convert(varchar,dbo.ConvertLongToDate(e.EventTime),101)+ '' '' + Convert(varchar,dbo.ConvertLongToDate(e.EventTime),108) as EventTime, '+
--' ( CASE	WHEN et.EventTypeGroupID = 5 THEN gr.GeoRuleName ELSE ''N/A'' END) as GeoRule, en.Note as EventNote,	u.UserName,	convert(varchar,en.CreatedDate,101) + '' '' + convert(varchar,en.CreatedDate,108) as CreatedDate,'+
--' ISNULL(o.FirstName + '' '', '''') + ISNULL(o.MiddleName + '' '', '''') + ISNULL(o.LastName, '''')as OffenderName,o.homePhone1 as OffenderPhone,o.HomeStreet1 + '' '' + o.HomeStreet2 as OffenderAddress,o.HomeCity as OffenderCity,'+
--' oState.Abbreviation as OffenderState, o.HomePostalCode as OffenderPostalCode, ISNULL(ofcr.FirstName + '' '', '''' ) +ISNULL(ofcr.MiddleName + '' '', '''' ) +	ISNULL(ofcr.LastName, '''') as OfficerName,ofcr.DayPhone as OfficerPhone,'+
--' ofcr.StreetLine1 + '' '' + ofcr.StreetLine2 as OfficerAddress, ofcr.City as OfficerCity,ofcrState.Abbreviation as OfficerState, ofcr.PostalCode as OfficerPostalCode,ofcr.EmailAddress1 as OfficerEmail,ag.Agency as AgencyName,'+
--' ag.Phone as AgencyPhone,ag.StreetLine1 + '' '' + ag.StreetLine2 as AgencyAddress,ag.City as AgencyCity,agState.Abbreviation AgencyState,ag.PostalCode as AgencyPostalCode,ag.OnCallPhone as AgencyOnCallPhone,ag.OnCallPager as AgencyOnCallPager,'+
--' ag.OnCallEmail as AgencyOnCallEmail,ag.AgencyID,ofcr.OfficerID,et.SO '+
--' FROM	dbo.fnEvents(Convert(datetime,''' + @StartDate + '''),Convert(datetime,'''+ @EndDate + ''')) e '+
--' INNER JOIN OffenderTrackerActivation ota on ota.trackerid = e.DeviceID AND ((ota.activateDate< Convert(DateTime,(DATEADD(ms, (e.EventTime / CAST(10000 AS bigint)) % 86400000,	DATEADD(day, e.EventTime / CAST(864000000000 AS bigint) - 109207, 0))))'+
--' and ota.DeActivateDate> Convert(DateTime,(DATEADD(ms, (e.EventTime / CAST(10000 AS bigint)) % 86400000,DATEADD(day, e.EventTime / CAST(864000000000 AS bigint) - 109207, 0))))) or (ota.activateDate<Convert(DateTime, (DATEADD(ms, (e.EventTime / CAST(10000 AS bigint)) % 86400000,'+
--' DATEADD(day, e.EventTime / CAST(864000000000 AS bigint) - 109207, 0)))) and ota.DeActivateDate is null)) LEFT JOIN EventType et ON e.EventID = et.EventTypeID LEFT JOIN EventNote en on e.Eventid = en.Eventid LEFT JOIN Offender o ON o.offenderID = ota.OffenderID AND o.Deleted = 0'+
--' LEFT JOIN State oState ON oState.StateID = o.HomeStateOrProvinceID LEFT JOIN Country oCountry ON oCountry.CountryID = o.HomeCountryID	LEFT JOIN Agency ag ON o.AgencyID = ag.AgencyID	LEFT JOIN State agState ON agState.StateID = ag.StateID	LEFT JOIN Country agCountry ON agCountry.CountryID = ag.CountryID'+
--' LEFT JOIN Offender_Officer oo ON o.OffenderID = oo.OffenderID	LEFT JOIN Officer ofcr ON ofcr.OfficerID = oo.OfficerID	LEFT JOIN State ofcrState ON ofcrState.StateID = ofcr.StateID	LEFT JOIN Country ofcrCountry ON ofcrCountry.CountryID = ofcr.CountryID	LEFT JOIN [User] u ON u.UserID = en.createdbyID'+
--' LEFT JOIN GeoRule gr ON gr.GeoRuleID = e.EventParameter'+
--' WHERE ( (e.EventTime >= 127961856000000000) ) and (' + @value2 + ')) as temp'

set @sql ='(SELECT DISTINCT '+  
		  	'	e.EventName as EventType, '+
		  	'	e.EventDateTime as EventTime, '+
			'	dbo.fxGetGeoRuleName(e.AlarmID) as GeoRule, '+
			'	en.Note as EventNote, '+
			'	u.UserName, '+
			'	en.CreatedDate, '+
			'	ISNULL(o.FirstName + '' '', '''') + ISNULL(o.MiddleName + '' '', '''') + ISNULL(o.LastName, '''') as OffenderName, '+
			'	o.homePhone1 as OffenderPhone, '+
			'	o.HomeStreet1 + '' '' + o.HomeStreet2 as OffenderAddress, '+
			'	o.HomeCity as OffenderCity, '+
			'	oState.Abbreviation as OffenderState, '+
			'	o.HomePostalCode as OffenderPostalCode, '+
			'	ISNULL(ofcr.FirstName + '' '', '''' ) +ISNULL(ofcr.MiddleName + '' '', '''' ) + '+
			'	ISNULL(ofcr.LastName, '''') as OfficerName, '+
			'	ofcr.DayPhone as OfficerPhone, '+
			'	ofcr.StreetLine1 + '' '' + ofcr.StreetLine2 as OfficerAddress, '+
			'	ofcr.City as OfficerCity, '+
			'	ofcrState.Abbreviation as OfficerState, '+
			'	ofcr.PostalCode as OfficerPostalCode, '+
			'	ofcr.EmailAddress1 as OfficerEmail, '+
			'	ag.Agency as AgencyName, '+
			'	ag.Phone as AgencyPhone, '+
			'	ag.StreetLine1 + '' '' + ag.StreetLine2 as AgencyAddress, '+
			'	ag.City as AgencyCity, '+
			'	agState.Abbreviation as AgencyState, '+
			'	ag.PostalCode as AgencyPostalCode, '+
			'	ag.OnCallPhone as AgencyOnCallPhone, '+
			'	ag.OnCallPager as AgencyOnCallPager, '+
			'	ag.OnCallEmail as AgencyOnCallEmail, '+
			'	e.AgencyID, '+
			'	e.OfficerID, '+
			'	e.SO '+
			' FROM	dbo.fnEvents(Convert(datetime, ''' + @StartDate + '''),Convert(datetime, '''+ @EndDate + ''')) e '+
			'	 INNER JOIN OffenderTrackerActivation ota WITH(NOLOCK) ON ota.trackerid = e.DeviceID  '+
			'		AND '+
			'		( '+
			'		 ((ota.activateDate < dbo.ConvertLongToDate(e.EventTime)) '+
			'			AND '+
			'		 (ota.DeActivateDate > dbo.ConvertLongToDate(e.EventTime)) '+
			'		 ) '+
			'		 OR '+
			'		 ((ota.activateDate < dbo.ConvertLongToDate(e.EventTime)) '+
			'			AND '+
			'		  (ota.DeActivateDate is null) '+
			'		 ) '+
			'		) '+
			'	 LEFT JOIN EventNote en WITH(NOLOCK) on e.Eventid = en.Eventid '+
			'	 LEFT JOIN [User] u WITH(NOLOCK) ON u.UserID = en.createdbyID '+
			'	 LEFT JOIN Offender o WITH(NOLOCK) ON e.OffenderID = o.offenderID AND o.Deleted = 0 '+
			'	 LEFT JOIN State oState WITH(NOLOCK) ON oState.StateID = o.HomeStateOrProvinceID '+
			'	 LEFT JOIN Officer ofcr WITH(NOLOCK) ON e.OfficerID = ofcr.OfficerID '+
			'	 LEFT JOIN State ofcrState WITH(NOLOCK) ON ofcrState.StateID = ofcr.StateID '+
			'	 LEFT JOIN Agency ag WITH(NOLOCK) ON e.AgencyID = ag.AgencyID '+
			'	 LEFT JOIN State agState WITH(NOLOCK) ON agState.StateID = ag.StateID '+
			' WHERE ( (e.EventTime >= 127961856000000000) ) and (' + @value2 + ')) as temp'

set @tempSql = @tempSql + @sql
exec (@tempSql)
END 
GO
GRANT VIEW DEFINITION ON [spEventReport] TO [db_object_def_viewers]
GO
GRANT EXECUTE ON [spEventReport] TO [db_dml]
GO
