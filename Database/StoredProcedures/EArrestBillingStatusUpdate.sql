/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:27 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [EArrestBillingStatusUpdate]

@OffenderID INT,    
 @BillingStatus BIT,   
 @UserID INT    
    
AS    
SET NOCOUNT ON;  
  
IF @@TRANCOUNT > 0  
 BEGIN  
  ROLLBACK TRANSACTION  
 END;  
  
BEGIN TRANSACTION;  
BEGIN TRY  
  
  DECLARE @UpdatedDate DATETIME;  
  SET @UpdatedDate=getdate();  
  
  IF  @BillingStatus = 1         
   BEGIN  
     INSERT INTO EArrestBillingStatus  
  (OffenderID,StartDate,EndDate,CreatedByID,ModifiedById,BillingStatus)   
  VALUES (@OffenderID,@UpdatedDate,NULL,@UserID,NULL,@BillingStatus)  
  
   END  
  ELSE  
   BEGIN 
     IF exists(select * from EArrestBillingStatus where offenderID=@OffenderID )
	  BEGIN   
		Update ebs   
		SET ebs.EndDate = @UpdatedDate, ebs.ModifiedById = @Userid,ebs.BillingStatus = @BillingStatus  
		From EArrestBillingStatus ebs  
		Where ebs.Offenderid = @Offenderid And ebs.EndDate IS NULL  
	  END
     ELSE
	  BEGIN
		INSERT INTO EArrestBillingStatus  
		  (OffenderID,StartDate,EndDate,CreatedByID,ModifiedById,BillingStatus)   
		  VALUES (@OffenderID,@UpdatedDate,@UpdatedDate,@UserID,NULL,@BillingStatus) 
	  END
   END  
  
END TRY  
BEGIN CATCH  
 --Catch and return error.  
    SELECT   
        ERROR_NUMBER() AS ErrorNumber,  
        ERROR_SEVERITY() AS ErrorSeverity,  
        ERROR_STATE() as ErrorState,  
        ERROR_PROCEDURE() as ErrorProcedure,  
        ERROR_LINE() as ErrorLine,  
        ERROR_MESSAGE() as ErrorMessage;  
 --Rollback outstanding transactions.  
 IF @@TRANCOUNT > 0  
  BEGIN  
   ROLLBACK TRANSACTION  
  END;  
END CATCH;  
  
IF @@TRANCOUNT > 0  
 BEGIN  
  COMMIT TRANSACTION  
 END;
GO
GRANT EXECUTE ON [EArrestBillingStatusUpdate] TO [db_dml]
GO
