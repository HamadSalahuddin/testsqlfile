/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:27 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [spCreateAlarmsReportForIntervalls] (
	-- Add the parameters for the stored procedure here
	@StartDate DateTime,
	@EndDate DateTime,
	@TimeZoneOffset int,
	@IntervalMinutes int
)
AS
BEGIN
	-- TrackerPal standard: All report @EndTime parameters are inclusive.  If time (not just date) is
	-- relevant, parameter must include seconds (but NOT milliseconds), and we add 1 second and use
	-- '<' on @EndDate comparisons to include correct data.  DK 4-9-07
	SET @EndDate = DATEADD(s, 1, @EndDate)

	-- Add TZ to the range, but subtract TZ on the output data.  DK 4-7-07
	SET @StartDate = DATEADD(minute, @TimeZoneOffset, @StartDate)
	SET @EndDate = DATEADD(minute, @TimeZoneOffset, @EndDate)

	DECLARE	@CurrentDate DateTime
	DECLARE	@CurrentNewDate DateTime
	set @CurrentDate=@StartDate

	DELETE FROM rprtAlarmsForInterval

	WHILE (@CurrentDate<@EndDate)
	BEGIN
		SET @CurrentNewDate=(SELECT DATEADD(n,@IntervalMinutes,@CurrentDate))
		IF (@CurrentNewDate > @EndDate)
		BEGIN
			SET @CurrentNewDate = @EndDate
		END
		INSERT rprtAlarmsForInterval exec spCreateAlarmsReport @CurrentDate,@CurrentNewDate,@TimeZoneOffset
		SET @CurrentDate=@CurrentNewDate
	END

	SELECT * FROM rprtAlarmsForInterval WITH(NOLOCK)
   ORDEr BY StartDate

	-- Because the ReportSite code uses a data reader that reads part of the data at a time, to be safe
	-- on potential data loss, we will NOT clear the table till we come back through to run the report
	-- again.  After further review, we may be able to put this back in.  DK 4-12-07
	--
	-- DELETE FROM rprtAlarmsForInterval
END

GO
GRANT VIEW DEFINITION ON [spCreateAlarmsReportForIntervalls] TO [db_object_def_viewers]
GO
GRANT EXECUTE ON [spCreateAlarmsReportForIntervalls] TO [db_dml]
GO
