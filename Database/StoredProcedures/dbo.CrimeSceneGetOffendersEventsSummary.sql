/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:27 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [CrimeSceneGetOffendersEventsSummary]

	
@StartDate datetime,
 @EndDate datetime,
 @Proximity float,
 @Latitude  float,
 @Longitude float,
 @AgencyID float

AS

Select * INTO #tempevents
From fnallevents ()
where EventDateTime >= @StartDate and EventDateTime <= @EndDate	
	
select e.offenderID , min(trackerPAL.dbo.[fnGetDistance](e.latitude,e.longitude,@Latitude,@Longitude)) as minDistance into #EventsTbl 
--from [fnEvents] ( @StartDate, @EndDate ) e
from #tempevents e
--[fnAllEvents] () e
join offender o on o.offenderid=e.offenderid and o.victim<>1  
--where e.EventDateTime >= @StartDate and e.EventDateTime <= @EndDate 
WHERE trackerPAL.dbo.[fnGetDistance](e.latitude,e.longitude,@Latitude,@Longitude) < @Proximity
group by e.offenderID 


select e.offenderID , count(*) as EventsCount into #EventsTbl2
--from [fnEvents] ( @StartDate, @EndDate ) e
from #tempevents e
--[fnEvents] ( @StartDate, @EndDate) e --[fnAllEvents] () e
join offender o on o.offenderid=e.offenderid and o.victim<>1  
where e.EventDateTime >= @StartDate and e.EventDateTime <= @EndDate 
and trackerPAL.dbo.[fnGetDistance](e.latitude,e.longitude,@Latitude,@Longitude) < @Proximity
group by e.offenderID 


select tb.OffenderID ,Convert(varchar,tb.MinDistance) + ' miles' as mindistance, tb2.EventsCount,a.Agency, ISNULL(o.LastName + ', ', '') + ISNULL(o.FirstName, '') AS 'OfficerName',
case 
	when a.AgencyID <> @AgencyID then ISNULL(oe.CaseNumber,' ')
	else ISNULL(oe.LastName +', ',' ') + ISNULL(oe.FirstName, '')
end as 'OffenderName',a.AgencyID 

from #EventsTbl tb
inner join #EventsTbl2 tb2 on tb2.offenderID= tb.offenderID
inner join offender oe on oe.offenderID = tb.offenderID
inner join Offender_Officer oo on tb.offenderID =oo.offenderID
inner join Agency a on oe.AgencyId = a.AgencyID 
inner join Officer o on o.OfficerID =oo.OfficerID

drop table #tempevents



GO
GRANT VIEW DEFINITION ON [CrimeSceneGetOffendersEventsSummary] TO [db_object_def_viewers]
GO
GRANT EXECUTE ON [CrimeSceneGetOffendersEventsSummary] TO [db_dml]
GO
