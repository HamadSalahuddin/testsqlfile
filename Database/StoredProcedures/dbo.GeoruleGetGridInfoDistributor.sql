/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:27 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [GeoruleGetGridInfoDistributor]

@UserId int,
@OffenderId int = NULL

AS
BEGIN

SELECT	
	g.GeoRuleID,
	g.GeoRuleName,
	0 AS 'Selected',
	g.StatusID,
	gs.GeoRuleStatusName,
	g.FileID,
	g.UpdateInProgress
FROM	GeoRule g
	INNER JOIN GeoruleStatus gs on gs.GeoruleStatusID = g.StatusID
	LEFT JOIN GeoRule_Agency ga ON g.GeoRuleID = ga.GeoRuleID
WHERE 
	g.Deleted = 0 
	AND g.GeoRuleID NOT IN (SELECT GeoRuleID FROM GeoRule_Offender)
	AND (g.CreatedById = @UserId
	OR ga.AgencyID IN (SELECT AgencyID FROM Agency WHERE DistributorID IN (SELECT DistributorID FROM DistributorEmployee WHERE UserId = @UserId ) ))
UNION
SELECT	
	g.GeoRuleID,
	g.GeoRuleName,
	1 AS 'Selected',
	g.StatusID,
	gs.GeoRuleStatusName,
	g.FileID,
	g.UpdateInProgress
FROM	GeoRule g
	INNER JOIN GeoruleStatus gs on gs.GeoruleStatusID= g.StatusID
WHERE 
	g.Deleted = 0 
	AND g.GeoRuleID IN (SELECT GeoRuleID FROM GeoRule_Offender WHERE OffenderID = @OffenderID)
ORDER BY 'Selected' DESC, g.GeoRuleName

END
GO
GRANT EXECUTE ON [GeoruleGetGridInfoDistributor] TO [db_dml]
GO
