/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:27 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [OffenderGetOverviewBySearch]

	@FirstName	NVARCHAR(50),
	@LastName	NVARCHAR(50),
	@AgencyID	INT,
	@OfficerID	INT,
	@RoleID		INT,
	@OffenderID INT = -1,
	@UserID INT
	

AS

		IF @RoleID = 2 OR @RoleID = 3
	BEGIN
		SELECT	o.OffenderID,
				ISNULL(o.LastName , '') +
				', ' +
				ISNULL(o.FirstName , '') + 
				ISNULL(' ' + o.MiddleName , '')  AS 'OffenderName', 
				o.RiskLevelID,
				ISNULL(o.Victim, 'false') AS Victim
		FROM	Offender o
		WHERE	o.Deleted = 0 AND
				(  
				  ( 
					@OffenderID<0 and
					o.AgencyID = @AgencyID AND
					(o.FirstName LIKE '%' + @FirstName + '%') AND
					(o.LastName LIKE '%' + @LastName + '%')
				  )
				  or
				  (
					o.offenderId= @OffenderID
				  )
				)
				
		ORDER BY o.LastName, o.FirstName
	END
	ELSE IF  @RoleID = 19 /*TAM*/
	BEGIN
		SELECT	o.OffenderID,
				ISNULL(o.LastName , '') +
				', ' +
				ISNULL(o.FirstName , '') + 
				ISNULL(' ' + o.MiddleName , '')  AS 'OffenderName', 
				o.RiskLevelID,
				ISNULL(o.Victim, 'false') AS Victim
		FROM	Offender o
		inner join Agency a on a.Agencyid = o.Agencyid 
		inner join distributor d on d.DistributorID= a.DistributorID and d.TamID=@UserID
		WHERE	o.Deleted = 0 AND
				(  
				  ( 
					@OffenderID<0 and
					(o.FirstName LIKE '%' + @FirstName + '%') AND
					(o.LastName LIKE '%' + @LastName + '%')
				  )
				  or
				  (
					o.offenderId= @OffenderID
				  )
				)
				
		ORDER BY o.LastName, o.FirstName
	END
	ELSE IF  @RoleID = 6  /*Distributor*/
	BEGIN
		SELECT	o.OffenderID,
				ISNULL(o.LastName , '') +
				', ' +
				ISNULL(o.FirstName , '') + 
				ISNULL(' ' + o.MiddleName , '')  AS 'OffenderName', 
				o.RiskLevelID,
				ISNULL(o.Victim, 'false') AS Victim
		FROM	Offender o
			inner join Agency a on a.Agencyid = o.Agencyid 
		inner join distributoremployee de on a.DistributorID=de.DistributorID and de.UserID=@UserID
	WHERE	o.Deleted = 0 AND
				(  
				  ( 
					@OffenderID<0 and
                    o.AgencyID = @AgencyID AND
					(o.FirstName LIKE '%' + @FirstName + '%') AND
					(o.LastName LIKE '%' + @LastName + '%')
                     
				  )
				  or
				  (
					o.offenderId= @OffenderID
				  )
				)
				
		ORDER BY o.LastName, o.FirstName
	END
	ELSE
	BEGIN

		SELECT	o.OffenderID,
				ISNULL(o.LastName , '') +
				', ' +
				ISNULL(o.FirstName , '') + 
				ISNULL(' ' + o.MiddleName , '')  AS 'OffenderName', 
				o.RiskLevelID,
				ISNULL(o.Victim, 'false') AS Victim
		FROM	Offender o
		left JOIN Offender_Officer oo ON o.OffenderID = oo.OffenderID
	WHERE	o.Deleted = 0 AND
			(
			  (
			  	@OffenderID<0 and
				(( @AgencyID = 0)or(o.AgencyID = @AgencyID)) AND
				((@OfficerID = 0 )or(oo.OfficerID = @OfficerID)) AND
				(o.FirstName LIKE '%' + @FirstName + '%') AND
				(o.LastName LIKE '%' + @LastName + '%')
			  )
			  or
			  (
				  o.offenderId= @OffenderID
			  )
			)	
	ORDER BY o.LastName, o.FirstName
	END


GO
GRANT VIEW DEFINITION ON [OffenderGetOverviewBySearch] TO [db_object_def_viewers]
GO
GRANT EXECUTE ON [OffenderGetOverviewBySearch] TO [db_dml]
GO
