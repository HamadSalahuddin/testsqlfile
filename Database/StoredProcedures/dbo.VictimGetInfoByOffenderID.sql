/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:28 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [VictimGetInfoByOffenderID]
	@iOffenderID int,
	@GetDeleted BIT = 1 -- Change this to 0 to allow filtering by Deleted field
AS
BEGIN
	SET NOCOUNT ON;

	SELECT 
		CASE 
			WHEN ta.TrackerAssignmentTypeID = 1 
			THEN ta.TrackerID
			ELSE 0 
		END AS 'TrackerID',
		o.[OffenderID],
		o.[AgencyID],
		o.[OffenderNumber],
		o.[SalutationID],
		o.[FirstName],
		o.[MiddleName],
		o.[LastName],
		o.[SuffixID],
		o.[GenderID],
		o.[BirthDate],
		o.[HomeStreet1],
		o.[HomeStreet2],
		o.[HomeCity],
		o.[HomeStateOrProvinceID],
		o.[HomeCountryID],
		o.[HomePostalCode],
		o.[HomePhone1TypeID],
		o.[HomePhone2TypeID],
		o.[HomePhone3TypeID],
		o.[HomePhone4TypeID],
		o.[HomePhone1],
		o.[HomePhone2],
		o.[HomePhone3],
		o.[HomePhone4],
		o.[HomePropertyOwner],
		o.[HomePropertyOwnerPhone],
		o.[VictimProxViolationDistance],
		o.[VictimProxAlertDistance],
		o.[VictimAssociatedOffenderID],
		o.[CreatedDate],
		o.[CreatedByID],
		o.[ModifiedDate],
		o.[ModifiedByID],
		o.[Deleted],
		o.[PrimaryLanguageID],
		ofof.OfficerID, ta.TrackerAssignmentID
	FROM 
		[Offender] o
		LEFT JOIN [TrackerAssignment] ta ON ta.TrackerAssignmentID = 
			(
				SELECT MAX(TrackerAssignmentID) 
				FROM [TrackerAssignment] ta 
				WHERE ta.OffenderID = @iOffenderID
			)
		LEFT JOIN [Offender_Officer] ofof ON ofof.OffenderID = o.OffenderID
	WHERE 
		o.OffenderID = @iOffenderID AND (@GetDeleted = 1 OR o.Deleted = 0)
	    AND o.Victim = 1
END
GO
GRANT EXECUTE ON [VictimGetInfoByOffenderID] TO [db_dml]
GO
GRANT VIEW DEFINITION ON [VictimGetInfoByOffenderID] TO [db_object_def_viewers]
GO
