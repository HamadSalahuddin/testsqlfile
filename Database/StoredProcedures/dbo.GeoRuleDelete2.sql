/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:27 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
-- =============================================
-- Author:		Keith Griffiths
-- Create date: Oct 22, 2009
-- Description:	The mapping 5.37 version for deleting a georule
-- =============================================
CREATE PROCEDURE [GeoRuleDelete2]
	@GeoRuleID INT
AS
BEGIN
	SET NOCOUNT ON;
	BEGIN TRAN
		--Delete Schedule records tied to Geofence No constraints aaaargggg! Very inefficient but database structure problems.	
		DECLARE @GeoRuleScheduleID INT
		DECLARE @GeoRuleReferencePointID INT
		
		SET @GeoRuleScheduleID = (SELECT GeoRuleScheduleID FROM GeoRule WHERE GeoRuleID = @GeoRuleID)
		SET @GeoRuleReferencePointID = (SELECT GeoRuleReferencePointID FROM GeoRule WHERE GeoRuleID = @GeoRuleID)

		DELETE FROM GeoRuleSchedule WHERE GeoRuleScheduleID = @GeoRuleScheduleID
		IF @@ERROR <> 0
		BEGIN
			ROLLBACK TRAN
			return 1
		END

		--Delete Reference records tied to Geofence No constraints aaaargggg!	
		DELETE FROM GeoRuleReferencePoint WHERE GeoRuleReferencePointID = @GeoRuleReferencePointID
		IF @@ERROR <> 0
		BEGIN
			ROLLBACK TRAN
			return 2
		END

		--Delete GeoRule_Agency records tied to Geofence No constraints aaaargggg!	
		DELETE FROM GeoRule_Agency WHERE GeoRuleID = @GeoRuleID
		IF @@ERROR <> 0
		BEGIN
			ROLLBACK TRAN
			return 3
		END

		--Delete GeoRule_Offender records tied to Geofence No constraints aaaargggg!	
		DELETE FROM GeoRule_Offender WHERE GeoRuleID = @GeoRuleID
		IF @@ERROR <> 0
		BEGIN
			ROLLBACK TRAN
			return 4
		END

		DELETE FROM GeoRule WHERE GeoRuleID = @GeoRuleID
		IF @@ERROR <> 0
		BEGIN
			ROLLBACK TRAN
			return 5
		END

	COMMIT TRAN
	RETURN 0
END


GO
GRANT EXECUTE ON [GeoRuleDelete2] TO [db_dml]
GO
