/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:27 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [CrimeSceneGetOffendersEvents]

	
 @StartDate datetime,
 @EndDate datetime,
 @Proximity float,
 @Latitude  float,
 @Longitude float,
 @AgencyID float,
 @TimeZoneOffset int 

AS


select * INTO #tmpevents
From fnallevents ()
where EventDateTime >= @StartDate and EventDateTime <= @EndDate

select e.offenderID , max(EventDateTime) as EventDateTime into #EventsTbl 
--from [fnEvents] ( @StartDate, @EndDate ) e
from #tmpevents e
--[fnAllEvents] () e
join offender o on o.offenderid=e.offenderid and o.victim<>1  
where e.EventDateTime >= @StartDate and e.EventDateTime <= @EndDate 
and trackerPAL.dbo.[fnGetDistance](e.latitude,e.longitude,@Latitude,@Longitude) < @Proximity
group by e.offenderID 

 
Select distinct e.EventID,e.OffenderID,a.Agency, 
ISNULL(o.LastName + ', ', '') + ISNULL(o.FirstName, '') AS 'OfficerName',
case 
	when a.AgencyID <> @AgencyID then ISNULL(oe.CaseNumber, ' ')
	else e.OffenderName
end as 'OffenderName',
case when e.Address is null 
then 'Lat. ' + cast(e.latitude as nvarchar) +', Long. ' +cast(e.longitude as nvarchar)
else e.Address
end as 'Address', 
(DATEADD ( mi, @TimeZoneOffset, (Convert(DateTime,
(DATEADD(ms, (e.EventTime / CAST(10000 AS bigint)) % 86400000,
DATEADD(day, e.EventTime / CAST(864000000000 AS bigint) - 109207, 0)))
)))) AS 'EventDateTime', e.latitude,e.Longitude, a.AgencyID,null as 'PointID',e.TrackerNumber
from #EventsTbl et
join #tmpevents e on e.offenderid = et.offenderID and e.Eventdatetime = et.EventDateTime
join offender oe on oe.offenderID = et.offenderID
join Agency a on e.AgencyId = a.AgencyID 
join Officer o on o.OfficerID =e.OfficerID

Drop table #tmpevents
 




GO
GRANT VIEW DEFINITION ON [CrimeSceneGetOffendersEvents] TO [db_object_def_viewers]
GO
GRANT EXECUTE ON [CrimeSceneGetOffendersEvents] TO [db_dml]
GO
