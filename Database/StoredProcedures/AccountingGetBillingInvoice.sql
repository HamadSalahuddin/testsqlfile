/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:26 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [AccountingGetBillingInvoice]

	@CustomerID	int = 0,
	@StartDate  DateTime,
    @EndDate    DateTime      

AS

BEGIN

SELECT DISTINCT
	ag.Agency AS 'AgencyName',
	ag.AgencyID,
	ota.ActivateDate, 
	ota.DeActivateDate, 
	acc.BillingRate,
	acc.DiscountRate AS 'Discount',
	acc.BillingPer,
	0 AS 'Days',
	0 AS 'Amount',
	ISNULL(o.LastName + ', ', '') + ISNULL(o.FirstName, '') AS 'OffenderName', 
	o.OffenderID,
	o.BirthDate,
	t.TrackerID,
	t.TrackerNumber,
	t.IsDemo,
	tb.Status AS 'Billable',
	ISNULL(ocr.LastName + ', ', '') + ISNULL(ocr.FirstName, '') AS 'OfficerName',
	ag.Agency, 
	ag.Streetline1, 
	ag.Streetline2, 
	ag.City, 
	(SELECT Abbreviation FROM State st WHERE st.StateID = ag.StateID) AS 'StateID',
	(SELECT [State] FROM State st WHERE st.StateID = ag.StateID) AS 'StateName', 
	ag.PostalCode, 
	ag.Phone,
	acc.TaxRate AS 'tax', 
	acc.CustomerAccountID,
	ota.BillableID AS 'TrackerBillableID'
FROM 
	OffenderTrackerActivation ota
	INNER JOIN Offender o ON o.OffenderID = ota.OffenderID 
	INNER JOIN Officer ocr ON ocr.OfficerID = ota.OfficerID 
	INNER JOIN Agency ag ON ag.AgencyID = ocr.AgencyID 
	INNER JOIN Tracker t ON t.TrackerID = ota.TrackerID 
	LEFT JOIN TrackerBillable tb ON tb.TrackerBillableID = ota.BillableID
	INNER JOIN Accounting acc ON acc.ID = ag.AgencyID 
	LEFT JOIN TimeZone tz ON tz.TimeZoneID = ag.TimeZoneID 
WHERE 
	(
		(@CustomerID <= 0) 
		OR
		(ag.AgencyID = @CustomerID)
	)
	AND
	(
		(ota.ActivateDate < DATEADD(day,1,@EndDate) AND ota.DeActivateDate > @StartDate)
		OR
		(ota.ActivateDate < DATEADD(day,1,@EndDate) AND ota.DeActivateDate IS NULL)
	)
ORDER BY 
	ag.Agency, t.TrackerNumber, ota.ActivateDate, 'OffenderName'
	
END
GO
GRANT EXECUTE ON [AccountingGetBillingInvoice] TO [db_dml]
GO
GRANT VIEW DEFINITION ON [AccountingGetBillingInvoice] TO [db_object_def_viewers]
GO
