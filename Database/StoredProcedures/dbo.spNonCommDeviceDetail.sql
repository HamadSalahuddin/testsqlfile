/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:28 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [spNonCommDeviceDetail]

AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

	SELECT DISTINCT
	ag.agency	   
	,ISNULL(so.FirstName + ' ', '') + ISNULL(so.LastName, '') AS 'OfficerName'
	,so.DayPhone AS 'Officer Phone'
	,ISNULL(o.FirstName + ' ', '') + ISNULL(o.LastName, '') AS 'Offendername'
	,o.HomeCity 'Offender City'
   ,o.HomePostalCode
	,s.state
	,d.timeoutcount
	,dp7.Propertyvalue AS 'Device Serial'
	,LEFT (dp3.PropertyValue, 6) AS 'IMSI'
	,t.trackernumber AS 'IMEI'
	--,ota.ActivateDate
	--,ota.deactivatedate
	,dp4.Propertyvalue AS 'Sim Phone'
	,dp5.Propertyvalue AS 'Assigned Phone'
	,dp6.Propertyvalue AS 'ICCID'

	FROM OffenderTrackerActivation ota WITH(NOLOCK)
	LEFT JOIN Tracker t WITH(NOLOCK) ON t.TrackerID = ota.trackerID AND t.deleted = 0
	LEFT JOIN Agency ag WITH(NOLOCK) ON Ag.AgencyID = t.AgencyID
	LEFT JOIN Gateway.dbo.Devices g WITH(NOLOCK) ON g.DeviceID = ota.TrackerID
	LEFT JOIN Gateway.dbo.DeviceProperties dp3 WITH(NOLOCK) ON ota.trackerid = dp3.DeviceID AND dp3.PropertyID = '8202'
	LEFT JOIN Gateway.dbo.DeviceProperties dp4 WITH(NOLOCK) ON ota.trackerid = dp4.DeviceID AND dp4.PropertyID = '8203'
	LEFT JOIN Gateway.dbo.DeviceProperties dp5 WITH(NOLOCK) ON ota.trackerid = dp5.DeviceID AND dp5.PropertyID = '8206'
	LEFT JOIN Gateway.dbo.DeviceProperties dp6 WITH(NOLOCK) ON ota.trackerid = dp6.DeviceID AND dp6.PropertyID = '8204'
	LEFT JOIN Gateway.dbo.DeviceProperties dp7 WITH(NOLOCK) ON ota.trackerid = dp7.DeviceID AND dp7.PropertyID = '8012'
	LEFT JOIN Gateway.dbo.Devices d WITH(NOLOCK) ON d.deviceid = ota.trackerid
	LEFT JOIN Officer so WITH(NOLOCK) ON so.officerid = ota.officerid
	LEFT JOIN offender o WITH(NOLOCK) ON o.offenderid = ota.offenderid
	LEFT JOIN State s WITH(NOLOCK) ON s.stateid = o.Homestateorprovinceid

	WHERE ota.DeactivateDate IS NULL and d.timeoutcount > 0
	ORDER By ag.agency, o.HomePostalCode

GO
GRANT EXECUTE ON [spNonCommDeviceDetail] TO [db_dml]
GO
GRANT VIEW DEFINITION ON [spNonCommDeviceDetail] TO [db_object_def_viewers]
GO
