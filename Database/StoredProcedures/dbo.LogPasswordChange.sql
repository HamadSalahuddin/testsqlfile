/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:27 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [LogPasswordChange]
@LoggedByID INT,
@UserID INT
	
AS
BEGIN
	SET NOCOUNT ON;
	DECLARE @Operator INT, @Officer INT, @LogID INT;
    DECLARE @UserName NVARCHAR(25), @FirstName	NVARCHAR(50),
             @LastName	NVARCHAR(50), @Agency NVARCHAR(50);
	SET @Operator=1;
	SET @Officer=2;

	-- It creates the log for action PasswordChange
	EXEC dbo.LogAdd @LogID OUTPUT,1, @LoggedbyID
    -- Insert statements for procedure here
	SELECT	@UserName=ISNULL(u.UserName,''),
			@FirstName=
			CASE u.UserTypeID
				WHEN @Operator THEN  ISNULL(op.FirstName,'')
				WHEN @Officer THEN ISNULL(ofi.FirstName,'')
			END,
			
			@LastName=
			CASE u.UserTypeID
				WHEN @Operator THEN  ISNULL(op.LastName,'')
				WHEN @Officer THEN ISNULL(ofi.LastName,'')
			END,

			@Agency=ISNULL(ag.Agency,'')

	FROM    [User] u
	LEFT JOIN Operator op ON u.UserID=op.UserID
	LEFT JOIN Officer ofi ON u.UserID=ofi.UserID
	LEFT JOIN Agency ag ON ofi.AgencyID=ag.AgencyID	
	WHERE u.UserID=@UserID;

	EXEC dbo.LogPropertyAdd @LogID,1, @UserName
	EXEC dbo.LogPropertyAdd @LogID,2, @FirstName
	EXEC dbo.LogPropertyAdd @LogID,3, @LastName
	EXEC dbo.LogPropertyAdd @LogID,4, @Agency
END






GO
GRANT VIEW DEFINITION ON [LogPasswordChange] TO [db_object_def_viewers]
GO
GRANT EXECUTE ON [LogPasswordChange] TO [db_dml]
GO
