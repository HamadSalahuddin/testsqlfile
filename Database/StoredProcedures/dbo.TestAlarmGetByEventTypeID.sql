/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:28 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [TestAlarmGetByEventTypeID]

	@StartDate		BIGINT,
	@EndDate		BIGINT,
	@EventTypeID	INT,
	@SO				INT,
	@OPR			INT,
	@EventTypeGroupID int 

	
AS
	
		SELECT	a.AlarmID, 
				a.AlarmTypeID, 
				a.EventTime,
				ISNULL(aa.AlarmAssignmentStatusID,0) as 'AlarmAssignmentStatusID',
				ISNULL(aas.AlarmAssignmentStatusName,'Unassigned') as 'AlarmAssignmentStatusName',
				et.AbbrevEventType as EventName, 
				ISNULL(a.Longitude, 0) AS 'Longitude',
				ISNULL(a.Latitude, 0) AS 'Latitude',
				ISNULL(o.FirstName + ' ', '') + 
				ISNULL(o.MiddleName + ' ', '') + 
				ISNULL(o.LastName, '') AS 'OffenderName',
				o.OffenderID,
				(SELECT COUNT (*) FROM AlarmNote WHERE AlarmID = a.AlarmID) AS 'NoteCount',
				isnull(e.GpsValid,0) as 'GpsValid',
				isnull(e.GpsValidSatellites,0) as 'GpsValidSatellites',
				e.DeviceID, 
				e.EventID
			FROM	Alarm a
			LEFT JOIN EventType et ON a.EventTypeID = et.EventTypeID
			left join GAteway.dbo.events e on e.DeviceID = a.TrackerID and 
					e.EventTime = a.EventTime and 
					e. Eventid= a.eventtypeid
			join OffenderTrackerActivation ota on ota.OffenderID = a.OffenderID and ota.TrackerID =a.TrackerID AND(
			 (ota.activateDate< a.EventDisplayTime
			 and ota.DeActivateDate> a.EventDisplayTime)
			or
			(ota.activateDate<a.EventDisplayTime
			 and ota.DeActivateDate is null))
			inner JOIN Offender o ON a.OffenderID = o.OffenderID
			left join AlarmAssignment aa on a.alarmId = aa.alarmid AND aa.AssignedDate = (SELECT MAX(AssignedDate) FROM AlarmAssignment AAD WHERE aad.AlarmID = a.AlarmID)
			left join AlarmAssignmentStatus aas on aas.AlarmAssignmentStatusID = aa.AlarmAssignmentStatusID 
					
		WHERE	a.AlarmID NOT IN (SELECT AlarmID FROM AlarmAcknowledgement)
					and (
							( @StartDate = 0 AND @EndDate = 0) 
							or
							(a.EventTime >= @StartDate AND
							a.EventTime <= @EndDate
							)
						 )
					and	(
							(@EventTypeID<0)
							or
							(a.EventTypeID = @EventTypeID)
						)
					and (
							(@SO<0)
							or
							(et.SO=@SO)
						)
					and (
							(@OPR<0)
							or
							(et.OPR=@OPR)
						)
					and	(
							(@EventTypeGroupID < 0)
							or
							(et.EventTypeGroupID = @EventTypeGroupID )
						)
				ORDER BY a.EventTime DESC, a.AlarmTypeID DESC 










GO
GRANT VIEW DEFINITION ON [TestAlarmGetByEventTypeID] TO [db_object_def_viewers]
GO
GRANT EXECUTE ON [TestAlarmGetByEventTypeID] TO [db_dml]
GO
