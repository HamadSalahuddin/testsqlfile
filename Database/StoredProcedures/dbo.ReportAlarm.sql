/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:27 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [ReportAlarm]

        @StartDate              BIGINT,
        @EndDate                BIGINT,
        @AgencyID               INT,
        @OfficerID              INT,
        @TimeZoneOffset INT
        
AS
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;     
        SELECT TOP 5000 
                e.AlarmID,
                --a.AlarmTypeID,
                e.EventDateTime,
                (DATEADD ( mi, @TimeZoneOffset, (CONVERT(DATETIME,e.EventDateTime)))) AS 'EventTime',
                e.EventName,
				e.Address,
				e.Offendername AS 'OffenderName',
                e.OffenderID,
                ISNULL(officer.FirstName + ' ', '') + 
                ISNULL(officer.MiddleName + ' ', '') + 
                ISNULL(officer.LastName, '') AS 'OfficerName',
                ag.Agency,
                (DATEADD ( mi, @TimeZoneOffset, (CONVERT(DATETIME,aa.AcknowledgedDate)))) AS 'AcknowledgedDate',
                --ota.ActivateDate,
                --ota.DeActivateDate,
		case when dbo.fnIsAlarmAutoCompleted(e.AlarmID) > 0 then 'Autocompleted Alarms' 
		else 'Regular Alarms' end as 'IsAlarmsAutoCompleted'
        FROM    
         (select AlarmID,EventDateTime, EventName, Address, OffenderName, OffenderID, DeviceID, OfficerID, AgencyID, AlarmType, EventTime
				 from rprtEventsBucket1
				 where EventTime BETWEEN @StartDate AND @EndDate
				 union
				 select AlarmID,EventDateTime, EventName, Address, OffenderName, OffenderID, DeviceID, OfficerID, AgencyID, AlarmType, EventTime
				 from rprtEventsBucket2
				 where EventTime BETWEEN @StartDate AND @EndDate) e
                --JOIN OffenderTrackerActivation ota ON 
                        --ota.OffenderID = e.OffenderID AND 
                        --ota.TrackerID = e.DeviceID
                LEFT JOIN AlarmAcknowledgement aa ON aa.alarmid = e.alarmid
                INNER JOIN officer ON officer.OfficerID = e.OfficerID 
                INNER JOIN Agency ag ON ag.AgencyID = e.AgencyID
        WHERE    
                (
                        (@AgencyID= 0)
                        OR
                        (e.AgencyID = @AgencyID)
                )
                AND     
                (
                        (@OfficerID= 0)
                        OR
                        (e.OfficerID = @OfficerID)
                ) 
AND e.Alarmtype > 1
        ORDER BY IsAlarmsAutoCompleted, e.EventTime ASC, e.AlarmType ASC






GO
GRANT VIEW DEFINITION ON [ReportAlarm] TO [db_object_def_viewers]
GO
GRANT EXECUTE ON [ReportAlarm] TO [db_dml]
GO
