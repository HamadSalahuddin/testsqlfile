/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:50:28 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: PROCEDURE
*/
CREATE PROCEDURE [spReportAgencyActivationByMonth]
--DECLARE 
@StartDate Datetime,
@EndDate DateTime,
@Agencyid int

--SET @StartDate = '2008-11-01'
--SET @EndDate = '2008-12-01'
--SET @Agencyid =831
AS
Select
o.FirstName+' '+o.LastName AS 'Offender Name'
,CONVERT(varchar(30),DateADD(mi,tz.utcoffset,ota.ActivateDate),120) As ActivateDate
,ISNULL(CONVERT(varchar(30),DateADD(mi,tz.utcoffset,ota.DeactivateDate),120),'Active') As DeactivateDate
,dp.Propertyvalue AS 'Device Serial'

From Offendertrackeractivation ota
JOIN Offender o ON o.Offenderid = ota.Offenderid
JOIN Gateway.dbo.deviceproperties dp ON dp.deviceid = ota.trackerid and dp.propertyid = '8012'
JOIN Agency ag ON ag.agencyid = o.agencyid
JOIN timezone tz on tz.timezoneid = ag.timezoneid
Where 
ag.agencyid = @Agencyid AND 
DateADD(mi,tz.utcoffset,ota.ActivateDate) < @EndDate 
AND (DateADD(mi,tz.utcoffset,ota.DeactivateDate) > @StartDate OR ota.deactivatedate is NULL)
ORDER BY 'Offender Name'
GO
GRANT EXECUTE ON [spReportAgencyActivationByMonth] TO [db_dml]
GO
