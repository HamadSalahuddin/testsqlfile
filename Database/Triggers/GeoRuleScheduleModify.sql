/*
Script generated by Aqua Data Studio 8.0.2 on Jan-15-2010 01:24:57 PM
Database: TrackerPal
Schema: <All Schemas>
Objects: TRIGGER
*/
CREATE TRIGGER [dbo].[GeoRuleScheduleModify] 
--CREATE TRIGGER [GeoRuleScheduleModify] 
   ON  [dbo].[GeoRuleSchedule] 
   AFTER DELETE, UPDATE
AS 
BEGIN

    -- Insert statements for trigger here

		BEGIN
			INSERT INTO GeoRuleChangeLog (ModifiedDate,
            ModifiedByID,OriginalValues,NewValues,GeoRuleID,TrackerID,OffenderID)
			SELECT GetDate(),g.ModifiedByID,			
				'GeoRuleID:' +cast(g.GeoRuleID as varchar) + ' - ' +
				'GeoRuleName:'+g.GeoRuleName + ' - ' +
				'SCHEDULE Always on:' +  cast(d.alwaysOn as varchar) + ' - ' +
				'Start Time:' + cast(d.startTime as varchar) + ' - ' +
				'End Time:' + cast(d.endTime as varchar) + ' - ' +
				'Sunday:' + cast(d.Sunday as varchar) + ' - ' +			
				'Monday:' + cast(d.Monday as varchar) + ' - ' +			
				'Tuesday:' + cast(d.Tuesday as varchar) + ' - ' +			
				'Wednesday:' + cast(d.Wednesday as varchar) + ' - ' +			
				'Thursday:' + cast(d.Thursday as varchar) + ' - ' +			
				'Friday:' + cast(d.Friday as varchar) + ' - ' +			
				'Saturday:' + cast(d.Saturday as varchar) ,
				
				'GeoRuleID:' +cast(g.GeoRuleID as varchar) + ' - ' +
				'GeoRuleName:'+g.GeoRuleName + ' - ' +
				'SCHEDULE Always on:' +  cast(i.alwaysOn as varchar) + ' - ' +
				'Start Time:' + cast(i.startTime as varchar) + ' - ' +
				'End Time:' + cast(i.endTime as varchar) + ' - ' +
				'Sunday:' + cast(i.Sunday as varchar) + ' - ' +			
				'Monday:' + cast(i.Monday as varchar) + ' - ' +			
				'Tuesday:' + cast(i.Tuesday as varchar) + ' - ' +			
				'Wednesday:' + cast(i.Wednesday as varchar) + ' - ' +			
				'Thursday:' + cast(i.Thursday as varchar) + ' - ' +			
				'Friday:' + cast(i.Friday as varchar) + ' - ' +			
				'Saturday:' + cast(i.Saturday as varchar) ,
				g.GeoRuleID,
				o.TrackerID,
				o.OffenderID
			FROM deleted d
				left join inserted i ON d.GeoRuleScheduleID = i.GeoRuleScheduleID
				inner join GeoRule g on d.georulescheduleid = g.georulescheduleid
				inner join GeoRule_Offender geo_o ON g.GeoRuleID = geo_o.GeoRuleID
				inner join Offender o ON geo_o.OffenderID = o.OffenderID
			If @@Error<> 0
			BEGIN
				RAISERROR ('Error update change log', 16, 1)
				Rollback Transaction
			END
		END
END
GO
